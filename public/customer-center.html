<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고객센터 - 빠던나인 프로젝트 관리</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/common.css">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4f0d4 100%);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(245, 241, 235, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .navbar .container-fluid {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            width: 100% !important;
        }
        
        .navbar .navbar-brand {
            flex: 0 0 auto !important;
            margin-right: 0 !important;
            order: 1 !important;
            font-weight: 700;
            font-size: 1.3rem;
            color: #333 !important;
        }
        
        .navbar .navbar-nav.mx-auto {
            flex: 1 !important;
            display: flex !important;
            justify-content: center !important;
            margin: 0 !important;
            order: 2 !important;
        }
        
        .navbar .navbar-nav:last-child {
            flex: 0 0 auto !important;
            margin-left: auto !important;
            order: 3 !important;
            position: absolute !important;
            right: 20px !important;
        }
        
        .navbar .navbar-text {
            color: #333 !important;
            font-weight: 500;
            margin: 0 !important;
        }
        
        .navbar .nav-link {
            color: #333 !important;
        }
        
        .navbar .nav-link:hover {
            color: #007bff !important;
        }

        .main-container {
            padding-top: 80px;
            padding-bottom: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .page-title {
            margin: 0;
            color: #333;
            font-weight: 700;
            font-size: 1.8rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-pending { color: #ffc107; }
        .stat-answered { color: #17a2b8; }
        .stat-closed { color: #28a745; }
        .stat-total { color: #6c757d; }

        .controls-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-control {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 6px;
            padding: 8px 16px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .inquiries-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table {
            margin: 0;
        }

        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
            color: #495057;
        }

        .table td {
            vertical-align: middle;
        }

        .table a {
            color: #007bff;
            text-decoration: none;
        }

        .table a:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-answered {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-closed {
            background-color: #d4edda;
            color: #155724;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .priority-high {
            background-color: #f8d7da;
            color: #721c24;
        }

        .priority-medium {
            background-color: #fff3cd;
            color: #856404;
        }

        .priority-low {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            font-weight: 600;
            color: #333;
        }

        .inquiry-content {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .reply-content {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .loading, .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading i {
            margin-right: 8px;
        }

        .category-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .category-game {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .category-general {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .category-technical {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .category-billing {
            background-color: #e8f5e8;
            color: #388e3c;
        }

        @media (max-width: 768px) {
            .search-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-controls .input-group {
                min-width: auto;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 통계 카드 스타일 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: #f0f8ff; /* 엷은 소라색 */
            color: #000000; /* 검정색 글자 */
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            margin: 0 0 2px 0;
            font-weight: 700;
        }

        .stat-card p {
            font-size: 0.375rem;
            margin: 0;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid px-3">
            <!-- 왼쪽: 홈 아이콘과 제목 -->
            <div class="d-flex align-items-center">
                <a href="/" class="navbar-brand">
                    <i class="fas fa-cogs me-2"></i>
                    빠던나인
                </a>
            </div>
            
            <!-- 중간: 로그인한 직원 이름 -->
            <div class="navbar-nav mx-auto">
                <span class="navbar-text" id="userName">
                    <i class="fas fa-user-circle me-2"></i> 사용자
                </span>
            </div>
            
            <!-- 오른쪽: 로그아웃 버튼 -->
            <div class="navbar-nav">
                <div class="nav-item" id="logoutItem" style="display: none;">
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="page-title">
                    <i class="fas fa-headset"></i> 고객센터
                </h1>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> 메인으로
                </a>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number stat-total" id="totalInquiries">0</div>
                <div class="stat-label">전체 문의</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-pending" id="pendingInquiries">0</div>
                <div class="stat-label">답변 대기</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-answered" id="answeredInquiries">0</div>
                <div class="stat-label">답변 완료</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-closed" id="closedInquiries">0</div>
                <div class="stat-label">처리 완료</div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="search-controls">
                <h4>고객 문의 관리</h4>
            </div>
        </div>

        <!-- Inquiries Table -->
        <div class="inquiries-table">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>번호</th>
                            <th>제목</th>
                                                         <th>작성자</th>
                             <th>사용자ID</th>
                             <th>카테고리</th>
                            <th>상태</th>
                            <th>등록일</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="inquiriesTableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <i class="fas fa-spinner fa-spin"></i> 데이터를 불러오는 중...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="문의 목록 페이지">
            <ul class="pagination" id="pagination">
            </ul>
        </nav>
    </div>

    <!-- Inquiry Detail Modal -->
    <div class="modal fade" id="inquiryDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inquiryModalTitle">문의 상세</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="inquiryModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="replyBtn" onclick="showReplyModal()">답변하기</button>
                    <button type="button" class="btn btn-success" id="closeBtn" onclick="closeInquiry()">처리완료</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div class="modal fade" id="replyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">답변 등록</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="replyContent">답변 내용</label>
                        <textarea class="form-control" id="replyContent" rows="6" placeholder="답변 내용을 입력하세요..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="submitReply()">답변 등록</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/js/korean-time.js"></script>
    <script>
        let currentPage = 1;
        let currentInquiryId = null;
        let currentInquiry = null;
        let dailyInquiryMap = new Map(); // 일별 번호 매핑

        // 현재 사용자 정보 로드
        async function loadCurrentUser() {
            try {
                console.log('사용자 정보 로드 시작');
                
                const userNameElement = document.getElementById('userName');
                const logoutItem = document.getElementById('logoutItem');
                const logoutBtn = document.getElementById('logoutBtn');
                
                // 먼저 API 호출로 실제 로그인 상태 확인
                try {
                    const response = await fetch('/api/employee/current-user', {
                        credentials: 'include',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('API 응답 상태:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('API 사용자 정보 응답:', data);
                
                if (data.success && data.user) {
                            console.log('API에서 로그인된 사용자 발견:', data.user);
                            // 로컬 스토리지에 저장
                            localStorage.setItem('currentUser', JSON.stringify(data.user));
                            
                            // UI 업데이트
                    userNameElement.textContent = data.user.name || data.user.username;
                    logoutItem.style.display = 'block';
                    
                            // 로그아웃 버튼 이벤트 리스너
                            logoutBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                if (confirm('로그아웃하시겠습니까?')) {
                                    logout();
                                }
                            });
                            return;
                        }
                    }
                } catch (apiError) {
                    console.error('API 호출 오류:', apiError);
                }
                
                // API에서 로그인 정보를 가져올 수 없는 경우, 로컬 스토리지 확인
                const storedUser = localStorage.getItem('currentUser');
                console.log('로컬 스토리지 사용자 정보:', storedUser);
                
                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    console.log('로컬 스토리지 사용자 정보:', user);
                    
                    // 로그인된 사용자가 있는 경우
                    userNameElement.textContent = user.name || user.username;
                    console.log('사용자 이름 표시:', user.name || user.username);
                    
                    // 로그아웃 버튼 표시
                    logoutItem.style.display = 'block';
                    
                    // 로그아웃 버튼 이벤트 리스너
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (confirm('로그아웃하시겠습니까?')) {
                            logout();
                        }
                    });
                } else {
                    console.log('로그인되지 않은 상태');
                    // 로그인되지 않은 경우
                    userNameElement.textContent = '사용자';
                    logoutItem.style.display = 'none';
                }
            } catch (error) {
                console.error('사용자 정보 로드 오류:', error);
                const userNameElement = document.getElementById('userName');
                const logoutItem = document.getElementById('logoutItem');
                userNameElement.textContent = '사용자';
                logoutItem.style.display = 'none';
            }
        }

        // 로그아웃 처리
        async function logout() {
            try {
                const response = await fetch('/api/employee/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 로컬 스토리지에서 사용자 정보 제거
                    localStorage.removeItem('currentUser');
                    console.log('로컬 스토리지에서 사용자 정보 제거');
                    
                    alert('로그아웃되었습니다.');
                    // 로그인 페이지로 이동
                    window.location.href = '/employee-login.html';
                } else {
                    alert('로그아웃 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('로그아웃 오류:', error);
                alert('서버 오류가 발생했습니다.');
            }
        }

        // 페이지 로드 시 실행
        window.onload = function() {
            loadCurrentUser();
            loadStats();
            loadInquiries();
        };

        // 통계 로드
        async function loadStats() {
            try {
                const response = await fetch('/api/customer-inquiries/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalInquiries').textContent = data.stats.total;
                    document.getElementById('pendingInquiries').textContent = data.stats.pending;
                    document.getElementById('answeredInquiries').textContent = data.stats.answered;
                    document.getElementById('closedInquiries').textContent = data.stats.closed;
                }
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }

        // 문의 목록 로드
        async function loadInquiries(page = 1) {
            try {
                let url = `/api/customer-inquiries?page=${page}&limit=10`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    // 일별 번호 매핑 생성
                    createDailyNumberMapping(data.inquiries);
                    displayInquiries(data.inquiries);
                    displayPagination(data.page, data.totalPages);
                    currentPage = data.page;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('문의 목록 로드 오류:', error);
                document.getElementById('inquiriesTableBody').innerHTML = 
                    '<tr><td colspan="8" class="no-data">데이터를 불러오는데 실패했습니다.</td></tr>';
            }
        }

        // 일별 번호 매핑 생성
        function createDailyNumberMapping(inquiries) {
            dailyInquiryMap.clear();
            
            // 날짜별로 그룹화
            const dailyGroups = {};
            inquiries.forEach(inquiry => {
                const date = new Date(inquiry.createdAt).toDateString();
                if (!dailyGroups[date]) {
                    dailyGroups[date] = [];
                }
                dailyGroups[date].push(inquiry);
            });
            
            // 각 날짜별로 번호 할당
            Object.keys(dailyGroups).forEach(date => {
                dailyGroups[date].forEach((inquiry, index) => {
                    dailyInquiryMap.set(inquiry._id, `${formatDateForNumber(inquiry.createdAt)}-${String(index + 1).padStart(2, '0')}`);
                });
            });
        }

        // 날짜를 번호용으로 포맷
        function formatDateForNumber(dateString) {
            const date = new Date(dateString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}${day}`;
        }

        // 문의 목록 표시
        function displayInquiries(inquiries) {
            const tbody = document.getElementById('inquiriesTableBody');
            
            if (inquiries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">등록된 문의가 없습니다.</td></tr>';
                return;
            }
            
            tbody.innerHTML = inquiries.map((inquiry) => {
                const dailyNumber = dailyInquiryMap.get(inquiry._id) || inquiry._id;
                return `
                    <tr>
                        <td>${dailyNumber}</td>
                        <td>
                            <a href="#" onclick="showInquiryDetail('${inquiry._id}')" class="text-primary">
                                ${inquiry.title || '제목 없음'}
                            </a>
                        </td>
                                                 <td>${inquiry.userName || '작성자 없음'}</td>
                         <td>${inquiry.userId || '사용자ID 없음'}</td>
                         <td>
                             <span class="category-badge category-${inquiry.category || 'general'}">
                                 ${getCategoryText(inquiry.category)}
                             </span>
                         </td>
                        <td>
                            <span class="status-badge status-${inquiry.status}">
                                ${getStatusText(inquiry.status)}
                            </span>
                        </td>
                        <td>${formatDate(inquiry.createdAt)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showInquiryDetail('${inquiry._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteInquiry('${inquiry._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 페이지네이션 표시
        function displayPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // 이전 페이지
            if (currentPage > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadInquiries(${currentPage - 1})">이전</a></li>`;
            }
            
            // 페이지 번호
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadInquiries(${i})">${i}</a></li>`;
                }
            }
            
            // 다음 페이지
            if (currentPage < totalPages) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadInquiries(${currentPage + 1})">다음</a></li>`;
            }
            
            pagination.innerHTML = paginationHtml;
        }

        // 문의 상세 보기
        async function showInquiryDetail(inquiryId) {
            try {
                const response = await fetch(`/api/customer-inquiries/${inquiryId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentInquiry = data.inquiry;
                    currentInquiryId = inquiryId;
                    
                    const modalTitle = document.getElementById('inquiryModalTitle');
                    const modalBody = document.getElementById('inquiryModalBody');
                    const replyBtn = document.getElementById('replyBtn');
                    const closeBtn = document.getElementById('closeBtn');
                    
                    modalTitle.textContent = data.inquiry.title;
                    
                    modalBody.innerHTML = `
                                                 <div class="row">
                             <div class="col-md-6">
                                 <strong>작성자:</strong> ${data.inquiry.userName || '작성자 없음'}
                             </div>
                             <div class="col-md-6">
                                 <strong>사용자ID:</strong> ${data.inquiry.userId || '사용자ID 없음'}
                             </div>
                         </div>
                         <div class="row mt-2">
                             <div class="col-md-6">
                                 <strong>카테고리:</strong> 
                                 <span class="category-badge category-${data.inquiry.category || 'general'}">
                                     ${getCategoryText(data.inquiry.category)}
                                 </span>
                             </div>
                            <div class="col-md-6">
                                <strong>상태:</strong> 
                                <span class="status-badge status-${data.inquiry.status}">
                                    ${getStatusText(data.inquiry.status)}
                                </span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <strong>등록일:</strong> ${formatDate(data.inquiry.createdAt)}
                            </div>
                            <div class="col-md-6">
                                <strong>수정일:</strong> ${formatDate(data.inquiry.updatedAt)}
                            </div>
                        </div>
                        <div class="mt-3">
                            <strong>문의 내용:</strong>
                            <div class="inquiry-content">${data.inquiry.content || '내용 없음'}</div>
                        </div>
                                                 ${data.inquiry.answer ? `
                         <div class="mt-3">
                             <strong>답변:</strong>
                             <div class="reply-content">${data.inquiry.answer}</div>
                             <small class="text-muted">답변일: ${formatDate(data.inquiry.answeredAt)}</small>
                         </div>
                         ` : ''}
                    `;
                    
                    // 버튼 상태 설정
                    replyBtn.style.display = data.inquiry.status === 'pending' ? 'inline-block' : 'none';
                    closeBtn.style.display = data.inquiry.status === 'answered' ? 'inline-block' : 'none';
                    
                    $('#inquiryDetailModal').modal('show');
                } else {
                    alert('문의를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('문의 상세 조회 오류:', error);
                alert('문의를 불러오는데 실패했습니다.');
            }
        }

        // 답변 모달 표시
        function showReplyModal() {
            $('#inquiryDetailModal').modal('hide');
            $('#replyModal').modal('show');
        }

        // 답변 등록
        async function submitReply() {
            try {
                const replyContent = document.getElementById('replyContent').value.trim();
                
                if (!replyContent) {
                    alert('답변 내용을 입력해주세요.');
                    return;
                }
                
                const response = await fetch(`/api/customer-inquiries/${currentInquiryId}/reply`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reply: replyContent
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('답변이 성공적으로 등록되었습니다.');
                    $('#replyModal').modal('hide');
                    document.getElementById('replyContent').value = '';
                    loadInquiries(currentPage);
                    loadStats();
                } else {
                    alert('답변 등록에 실패했습니다: ' + data.message);
                }
            } catch (error) {
                console.error('답변 등록 오류:', error);
                alert('답변 등록 중 오류가 발생했습니다.');
            }
        }

        // 문의 처리 완료
        async function closeInquiry() {
            try {
                if (!confirm('이 문의를 처리 완료 상태로 변경하시겠습니까?')) {
                    return;
                }
                
                const response = await fetch(`/api/customer-inquiries/${currentInquiryId}/close`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('문의가 처리 완료 상태로 변경되었습니다.');
                    $('#inquiryDetailModal').modal('hide');
                    loadInquiries(currentPage);
                    loadStats();
                } else {
                    alert('상태 변경에 실패했습니다: ' + data.message);
                }
            } catch (error) {
                console.error('상태 변경 오류:', error);
                alert('상태 변경 중 오류가 발생했습니다.');
            }
        }

        // 문의 삭제
        async function deleteInquiry(inquiryId) {
            try {
                if (!confirm('이 문의를 삭제하시겠습니까?')) {
                    return;
                }
                
                const response = await fetch(`/api/customer-inquiries/${inquiryId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('문의가 성공적으로 삭제되었습니다.');
                    loadInquiries(currentPage);
                    loadStats();
                } else {
                    alert('문의 삭제에 실패했습니다: ' + data.message);
                }
            } catch (error) {
                console.error('문의 삭제 오류:', error);
                alert('문의 삭제 중 오류가 발생했습니다.');
            }
        }

        // 유틸리티 함수들
        function getStatusText(status) {
            const statusMap = {
                'pending': '답변 대기',
                'answered': '답변 완료',
                'closed': '처리 완료'
            };
            return statusMap[status] || status;
        }

        function getCategoryText(category) {
            const categoryMap = {
                'game': '게임',
                'general': '일반',
                'technical': '기술',
                'billing': '결제'
            };
            return categoryMap[category] || category;
        }

        function formatDate(dateString) {
            return KoreanTime.formatKoreanTime(dateString, 'datetime');
        }
    </script>
</body>
</html> 