<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 게임 분석 - 회원관리 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/korean-time.js"></script>
    <style>
        .analysis-card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .analysis-card .card-body {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            color: #1a365d;
        }

        .analysis-card .card-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #1a365d;
        }

        .analysis-card .card-value {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #1a365d;
        }

        .live-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .winner-row {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745;
        }

        .loser-row {
            background-color: #f8d7da !important;
            border-left: 4px solid #dc3545;
        }

        .pending-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        .betting-choice {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background-color: #e9ecef;
        }

        .betting-choice.correct {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        .betting-choice.incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }

        .betting-choice.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        /* 사용자별 상세 분석 모달 반응형 */
        .user-detail-modal .modal-dialog {
            max-width: 95%;
        }

        .user-detail-modal .col-md-2 {
            margin-bottom: 10px;
        }

        .user-detail-modal .card {
            min-height: 120px;
            font-size: 0.85rem;
        }

        .user-detail-modal .card-header {
            padding: 8px;
            font-size: 0.8rem;
        }

        .user-detail-modal .card-body {
            padding: 10px;
        }

        .user-detail-modal .fw-bold {
            font-size: 0.9rem;
        }

        .user-detail-modal small {
            font-size: 0.7rem;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .user-detail-modal .col-md-2 {
                flex: 0 0 50%;
                max-width: 50%;
            }
            
            .user-detail-modal .card {
                min-height: 100px;
                font-size: 0.75rem;
            }
            
            .user-detail-modal .card-header {
                padding: 6px;
                font-size: 0.7rem;
            }
            
            .user-detail-modal .card-body {
                padding: 8px;
            }
        }

        /* 태블릿 반응형 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .user-detail-modal .col-md-2 {
                flex: 0 0 33.333333%;
                max-width: 33.333333%;
            }
        }

        .point-distribution {
            font-weight: bold;
            color: #28a745;
        }

        .total-pool {
            font-weight: bold;
            color: #007bff;
        }

        .win-rate {
            font-weight: bold;
            color: #ffc107;
        }

        body {
            padding-top: 80px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #E8F4FD 0%, #F0F8FF 100%);
            border-bottom: 1px solid #E1E8ED;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
        }

        .card-header h5 {
            margin: 0;
            color: #4A5568;
            font-weight: 600;
            font-size: 18px;
        }

        .card-body {
            padding: 20px;
            background-color: #FAFBFC;
        }

        .table {
            margin-bottom: 0;
            font-size: 14px;
        }

        .table th {
            background: linear-gradient(135deg, #F7FAFC 0%, #EDF2F7 100%);
            color: #2D3748 !important;
            font-weight: 600;
            font-size: 13px;
            padding: 12px 8px;
            border-bottom: 2px solid #E2E8F0;
            text-align: center;
        }

        .table td {
            padding: 10px 8px;
            border-bottom: 1px solid #F1F5F9;
            font-size: 13px;
            text-align: center;
            vertical-align: middle;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #F7FAFC;
        }

        .stats-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-summary h4 {
            margin-bottom: 15px;
            font-weight: 600;
        }

        .stats-grid {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .stats-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .stats-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 2px;
        }

        .stats-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2px;
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid px-3">
            <div class="d-flex align-items-center">
                <a href="/game-admin.html" class="navbar-brand">
                    <i class="fas fa-cogs me-2"></i>
                    빠던나인
                </a>
            </div>
            <div class="navbar-nav mx-auto">
                <span class="navbar-text" id="userName">
                    <i class="fas fa-user-circle me-2"></i> 사용자
                </span>
            </div>
            <div class="navbar-nav">
                <div class="nav-item" id="logoutItem" style="display: none;">
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-line me-2"></i>사용자 게임 분석</h2>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">
                    <i class="fas fa-check-circle me-1"></i>자동 초기화됨
                </span>
                <span class="badge bg-success me-2 live-indicator">
                    <i class="fas fa-circle"></i> LIVE
                </span>
                <small class="text-muted" id="lastUpdate">마지막 업데이트: --</small>
            </div>
        </div>
        
        <!-- 로그인 상태 요약 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-users me-2"></i>실시간 로그인 현황</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="h3 mb-0 text-primary" id="loggedInEmployees">0</div>
                                <small class="text-muted">직원 로그인</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h3 mb-0 text-success" id="loggedInMembers">0</div>
                                <small class="text-muted">회원 로그인</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h3 mb-0 text-info" id="totalLoggedIn">0</div>
                                <small class="text-muted">전체 로그인</small>
                            </div>
                            <div class="col-md-3">
                                <div class="h3 mb-0 text-warning" id="lastUpdateTime">--</div>
                                <small class="text-muted">마지막 업데이트</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 분석 요약 카드 -->
        <div class="stats-summary">
            <h5 class="mb-3"><i class="fas fa-trophy me-2"></i>오늘의 게임 분석 요약</h5>
            <div class="stats-grid">
                <div class="stats-item">
                    <div class="stats-value" id="totalGames">0</div>
                    <div class="stats-label">총 경기수</div>
                    </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalBettors">0</div>
                    <div class="stats-label">총 배팅자</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalPoints">₩0</div>
                    <div class="stats-label">총 배팅포인트</div>
            </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalWinners">0</div>
                    <div class="stats-label">총 승리자</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalDistributed">₩0</div>
                    <div class="stats-label">분배된 포인트</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="avgWinRate">0%</div>
                    <div class="stats-label">평균 승률</div>
                </div>
            </div>
        </div>





        <!-- 실시간 배팅 현황 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-line me-2"></i>실시간 배팅 현황</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshBettingData()">
                            <i class="fas fa-sync-alt"></i> 새로고침
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>회원명</th>
                                        <th>경기</th>
                                        <th>예측</th>
                                        <th>배팅 포인트</th>
                                        <th>배팅 시간</th>
                                        <th>상태</th>
                                    </tr>
                                </thead>
                                <tbody id="bettingTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>배팅 데이터를 불러오는 중...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 경기별 배팅 통계 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>경기별 배팅 통계</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="gameBettingStats">
                            <div class="col-12 text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>통계를 불러오는 중...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- 경기별 사용자 분석 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users me-2"></i>경기별 사용자 배팅 분석</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="color: #000;">경기</th>
                                        <th style="color: #000;">매치업</th>
                                        <th style="color: #000;">진행상태</th>
                                        <th style="color: #000;">예측결과</th>
                                        <th style="color: #000;">총 배팅자</th>
                                        <th style="color: #000;">총 배팅포인트</th>
                                        <th style="color: #000;">승리자 수</th>
                                        <th style="color: #000;">분배 포인트</th>
                                        <th style="color: #000;">승률</th>
                                        <th style="color: #000;">상세보기</th>
                                    </tr>
                                </thead>
                                <tbody id="gameAnalysisTableBody">
                                    <!-- 동적으로 생성됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 사용자별 상세 분석 모달 -->
        <div class="modal fade user-detail-modal" id="userDetailModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">사용자별 상세 분석</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="userDetailContent">
                            <!-- 동적으로 생성됨 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let updateInterval;
        let currentGamesData = [];








        // 배팅 데이터 새로고침
        async function refreshBettingData() {
            await loadBettingData();
            await loadGameBettingStats();
        }

        // 실시간 배팅 데이터 로드
        async function loadBettingData() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/betting/today-bets/${today}`);
                const result = await response.json();
                
                const tableBody = document.getElementById('bettingTableBody');
                
                if (result.success && result.data.length > 0) {
                    tableBody.innerHTML = result.data.map(bet => `
                        <tr>
                            <td>
                                <strong>${bet.memberName || '알 수 없음'}</strong>
                                <br><small class="text-muted">${bet.memberId || ''}</small>
                            </td>
                            <td>
                                <span class="badge bg-primary">${bet.gameNumber}경기</span>
                            </td>
                            <td>
                                <span class="badge bg-info">${bet.prediction}</span>
                            </td>
                            <td>
                                <strong class="text-success">₩${bet.points.toLocaleString()}</strong>
                            </td>
                            <td>
                                <small>${formatTime(bet.createdAt)}</small>
                            </td>
                            <td>
                                <span class="badge bg-${getBetStatusColor(bet.status)}">${bet.status}</span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>오늘 배팅 데이터가 없습니다.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('배팅 데이터 로드 오류:', error);
                document.getElementById('bettingTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>데이터 로드 중 오류가 발생했습니다.
                        </td>
                    </tr>
                `;
            }
        }

        // 경기별 배팅 통계 로드 (통계 컬렉션 사용)
        async function loadGameBettingStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/betting/all-games-stats/${today}`);
                const result = await response.json();
                
                const statsContainer = document.getElementById('gameBettingStats');
                
                if (result.success && result.data.length > 0) {
                    statsContainer.innerHTML = result.data.map(game => `
                        <div class="col-md-4 mb-3">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-gamepad me-2"></i>${game.gameNumber}경기</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="h5 mb-0 text-primary">${game.totalBettors}</div>
                                            <small class="text-muted">배팅자</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h5 mb-0 text-success">₩${game.totalPoints.toLocaleString()}</div>
                                            <small class="text-muted">총 배팅</small>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-12">
                                            <small class="text-muted">예측 분포:</small>
                                            <div class="mt-2">
                                                ${Object.entries(game.predictionCounts || {}).map(([prediction, count]) => 
                                                    `<span class="badge bg-secondary me-1 mb-1">${prediction}: ${count}명</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    statsContainer.innerHTML = `
                        <div class="col-12 text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>오늘 경기별 배팅 통계가 없습니다.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('경기별 배팅 통계 로드 오류:', error);
                document.getElementById('gameBettingStats').innerHTML = `
                    <div class="col-12 text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>통계 로드 중 오류가 발생했습니다.
                    </div>
                `;
            }
        }

        // 경기별 사용자 배팅 분석 테이블 업데이트
        async function updateGameAnalysisTable() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/betting/all-games-stats/${today}`);
                const result = await response.json();
                
                if (result.success) {
                    const tbody = document.getElementById('gameAnalysisTableBody');
                    let html = '';
                    
                    result.data.forEach(game => {
                        html += `
                            <tr>
                                <td>${game.gameNumber}경기</td>
                                <td>${game.matchup}</td>
                                <td>
                                    <span class="badge bg-${game.progressStatus === '경기끝' ? 'success' : 
                                        game.progressStatus === '경기중' ? 'warning' : 'secondary'}">
                                        ${game.progressStatus || '경기전'}
                                    </span>
                                </td>
                                <td>${game.predictionResult}</td>
                                <td>${game.totalBettors}</td>
                                <td>₩${game.totalBettors * 100}</td>
                                <td>${game.winPoints}</td>
                                <td>${game.winRate}%</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showGameDetail(${game.gameNumber})">
                                        <i class="fas fa-eye"></i> 상세보기
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                }
            } catch (error) {
                console.error('경기별 분석 테이블 업데이트 오류:', error);
            }
        }

        // 경기별 상세 정보 표시
        async function showGameDetail(gameNumber) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/betting/game-stats/${gameNumber}/${today}`);
                const result = await response.json();
                
                if (result.success) {
                    const game = result.data.find(g => g.gameNumber === gameNumber);
                    if (!game) return;
                    
                    const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
                    const content = document.getElementById('userDetailContent');
                    
                    let html = `
                        <h6>${gameNumber}경기 - ${game.matchup}</h6>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <strong>총 배팅자:</strong> ${game.totalBettors}명
                            </div>
                            <div class="col-md-3">
                                <strong>총 배팅 포인트:</strong> ₩${game.totalPoints.toLocaleString()}
                            </div>
                            <div class="col-md-3">
                                <strong>승리자 수:</strong> ${game.winners || 0}명
                            </div>
                            <div class="col-md-3">
                                <strong>승률:</strong> ${game.totalBettors > 0 ? 
                                    ((game.winners || 0) / game.totalBettors * 100).toFixed(1) : 0}%
                            </div>
                        </div>
                        <hr>
                        <h6>배팅자 상세 목록</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>회원명</th>
                                        <th>예측</th>
                                        <th>배팅 포인트</th>
                                        <th>배팅 시간</th>
                                        <th>상태</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    game.predictions.forEach(pred => {
                        const statusBadge = pred.status === 'won' ? 
                            '<span class="badge bg-success">승리</span>' :
                            pred.status === 'lost' ? 
                            '<span class="badge bg-danger">실패</span>' :
                            '<span class="badge bg-warning">대기</span>';
                        
                        html += `
                            <tr>
                                <td>${pred.userName}</td>
                                <td>${pred.prediction}</td>
                                <td>₩${pred.points.toLocaleString()}</td>
                                <td>${new Date(pred.betTime).toLocaleString('ko-KR')}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    content.innerHTML = html;
                    modal.show();
                }
            } catch (error) {
                console.error('경기별 상세 정보 조회 오류:', error);
            }
        }

        // 배팅 상태별 색상 반환
        function getBetStatusColor(status) {
            switch (status) {
                case '대기중': return 'secondary';
                case '진행중': return 'info';
                case '승리': return 'success';
                case '패배': return 'danger';
                default: return 'secondary';
            }
        }

        // 시간 포맷팅
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 실시간 사용자 현황 업데이트
        async function updateUserStats() {
            try {
                const response = await fetch('/api/monitoring/user-stats');
                const result = await response.json();
                
                if (result.success) {
                    // DOM 요소가 존재하는지 확인 후 업데이트
                    const loggedInCount = document.getElementById('loggedInCount');
                    const bettingCount = document.getElementById('bettingCount');
                    const choiceCount = document.getElementById('choiceCount');
                    const totalWinnings = document.getElementById('totalWinnings');
                    const currentLoggedInUsers = document.getElementById('currentLoggedInUsers');
                    const currentBettingUsers = document.getElementById('currentBettingUsers');
                    const totalBettingChoices = document.getElementById('totalBettingChoices');
                    
                    if (loggedInCount) loggedInCount.textContent = result.data.loggedInUsers || 0;
                    if (bettingCount) bettingCount.textContent = result.data.bettingUsers || 0;
                    if (choiceCount) choiceCount.textContent = result.data.totalChoices || 0;
                    if (totalWinnings) totalWinnings.textContent = `₩${(result.data.totalWinnings || 0).toLocaleString()}`;
                    
                    // 상단 요약 통계도 업데이트
                    if (currentLoggedInUsers) currentLoggedInUsers.textContent = result.data.loggedInUsers || 0;
                    if (currentBettingUsers) currentBettingUsers.textContent = result.data.bettingUsers || 0;
                    if (totalBettingChoices) totalBettingChoices.textContent = result.data.totalChoices || 0;
                }
            } catch (error) {
                console.error('사용자 통계 업데이트 오류:', error);
            }
        }

        // 로그인 상태 업데이트
        async function updateLoginStats() {
            try {
                const response = await fetch('/api/system/login-stats');
                const result = await response.json();
                
                if (result.success) {
                    const loggedInEmployees = document.getElementById('loggedInEmployees');
                    const loggedInMembers = document.getElementById('loggedInMembers');
                    const totalLoggedIn = document.getElementById('totalLoggedIn');
                    const lastUpdateTime = document.getElementById('lastUpdateTime');
                    
                    if (loggedInEmployees) loggedInEmployees.textContent = result.data.employees || 0;
                    if (loggedInMembers) loggedInMembers.textContent = result.data.members || 0;
                    if (totalLoggedIn) totalLoggedIn.textContent = result.data.total || 0;
                    if (lastUpdateTime) {
                        const updateTime = new Date(result.data.timestamp);
                        lastUpdateTime.textContent = updateTime.toLocaleTimeString('ko-KR');
                    }
                }
            } catch (error) {
                console.error('로그인 상태 업데이트 오류:', error);
            }
        }

        // 승리 포인트 계산
        async function calculateWinnings() {
            const gameNumber = document.getElementById('gameSelect').value;
            const prediction = document.getElementById('predictionResult').value;
            
            if (!gameNumber || !prediction) {
                alert('경기와 결과를 모두 선택해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/betting/calculate-winnings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gameNumber: parseInt(gameNumber),
                        prediction: prediction,
                        date: new Date().toISOString().split('T')[0]
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const calculationResult = document.getElementById('calculationResult');
                    calculationResult.innerHTML = `
                        <div class="row">
                            <div class="col-6">
                                <strong>총 배팅자:</strong> ${result.data.totalBettors}명<br>
                                <strong>총 배팅 포인트:</strong> ₩${result.data.totalPoints.toLocaleString()}<br>
                                <strong>승리자 수:</strong> ${result.data.winners.length}명<br>
                                <strong>실패자 수:</strong> ${result.data.losers.length}명
                            </div>
                            <div class="col-6">
                                <strong>실패자 총 포인트:</strong> ₩${result.data.totalLoserPoints.toLocaleString()}<br>
                                <strong>승리자당 지급 포인트:</strong> ₩${result.data.pointsPerWinner.toLocaleString()}<br>
                                <strong>총 지급 포인트:</strong> ₩${result.data.totalWinnings.toLocaleString()}
                            </div>
                        </div>
                        <hr>
                        <div class="mt-3">
                            <strong>승리자 목록:</strong><br>
                            ${result.data.winners.map(winner => 
                                `${winner.userName} (${winner.points}포인트 배팅)`
                            ).join('<br>')}
                        </div>
                    `;
                    
                    // 보상 지급 버튼 표시
                    document.getElementById('distributeBtn').style.display = 'inline-block';
                    
                    // 전역 변수에 계산 결과 저장
                    window.calculationData = result.data;
                } else {
                    alert('계산 중 오류가 발생했습니다: ' + result.message);
                }
            } catch (error) {
                console.error('승리 포인트 계산 오류:', error);
                alert('계산 중 오류가 발생했습니다.');
            }
        }

        // 보상 지급
        async function distributeWinnings() {
            if (!window.calculationData) {
                alert('먼저 승리 포인트를 계산해주세요.');
                return;
            }

            if (!confirm('정말로 승리자들에게 보상을 지급하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch('/api/betting/distribute-winnings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gameNumber: window.calculationData.gameNumber,
                        prediction: window.calculationData.prediction,
                        date: window.calculationData.date,
                        winners: window.calculationData.winners,
                        pointsPerWinner: window.calculationData.pointsPerWinner
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('보상이 성공적으로 지급되었습니다!');
                    document.getElementById('distributeBtn').style.display = 'none';
                    document.getElementById('calculationResult').innerHTML = '<p class="text-success">보상 지급 완료!</p>';
                    
                    // 사용자 통계 업데이트
                    updateUserStats();
                } else {
                    alert('보상 지급 중 오류가 발생했습니다: ' + result.message);
                }
            } catch (error) {
                console.error('보상 지급 오류:', error);
                alert('보상 지급 중 오류가 발생했습니다.');
            }
        }

        // team-games와 배팅 데이터 로드
        async function loadTeamGamesData() {
            try {
                const now = new Date();
                const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
                const today = koreanTime.toISOString().split('T')[0];
                
                console.log('[Monitoring] 데이터 로드 시작 - 날짜:', today);
                
                // team-games 데이터 로드
                const teamResponse = await fetch(`/api/team-games/${today}`);
                const teamResult = await teamResponse.json();
                
                console.log('[Monitoring] team-games API 응답:', teamResult);
                
                if (teamResult.success && teamResult.data) {
                    console.log('[Monitoring] team-games 데이터 로드됨:', teamResult.data.length, '개');
                    
                    // 배팅 통계 데이터 로드
                    const bettingResponse = await fetch(`/api/monitoring/game-betting-stats?date=${today}`);
                    const bettingResult = await bettingResponse.json();
                    
                    console.log('[Monitoring] 배팅 통계 API 응답:', bettingResult);
                    
                    // team-games 데이터에 배팅 통계 병합
                    const gamesWithBetting = teamResult.data.map(game => {
                        const bettingData = bettingResult.success && bettingResult.data ? 
                            bettingResult.data.games.find(b => b.gameNumber === game.gameNumber) : null;
                        
                        console.log(`[Monitoring] ${game.gameNumber}경기 배팅 데이터:`, bettingData);
                        
                        return {
                            ...game,
                            bettingChoices: bettingData ? bettingData.bettingChoices : {},
                            totalBettors: bettingData ? bettingData.totalBettors : 0,
                            totalPoints: bettingData ? bettingData.totalPoints : 0
                        };
                    });
                    
                    console.log('[Monitoring] 병합된 게임 데이터:', gamesWithBetting);
                    
                    currentGamesData = gamesWithBetting;
                    updateGameAnalysis(gamesWithBetting);
                    updateSummaryStats(gamesWithBetting);
                } else {
                    console.log('[Monitoring] team-games 데이터가 없거나 오류:', teamResult);
                }
                document.getElementById('lastUpdate').textContent = `마지막 업데이트: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('데이터 불러오기 오류:', error);
            }
        }

        // 게임 분석 업데이트
        function updateGameAnalysis(games) {
            const tableBody = document.getElementById('gameAnalysisTableBody');
            tableBody.innerHTML = '';

            games.forEach(game => {
                const row = document.createElement('tr');
                
                // 승리자 수와 분배 포인트 계산
                const analysis = calculateGameAnalysis(game);
                
                row.innerHTML = `
                    <td><strong>${game.gameNumber}경기</strong></td>
                    <td>${game.matchup || '-'}</td>
                    <td><strong class="game-progress">${game.progressStatus || '-'}</strong></td>
                    <td><strong class="prediction-result">${game.predictionResult || '-'}</strong></td>
                    <td><strong class="total-bettors">${analysis.totalBettors}</strong></td>
                    <td><strong class="total-pool">₩${analysis.totalPoints.toLocaleString()}</strong></td>
                    <td><strong class="point-distribution">${analysis.winners}</strong></td>
                    <td><strong class="point-distribution">₩${analysis.distributedPoints.toLocaleString()}</strong></td>
                    <td><strong class="win-rate">${analysis.winRate}%</strong></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showUserDetails(${game.gameNumber})">
                            <i class="fas fa-eye"></i> 상세보기
                        </button>
                    </td>
                `;

                // 경기 상태에 따른 행 스타일 적용
                if (game.progressStatus === '경기끝') {
                    row.classList.add('completed');
                } else if (game.progressStatus === '경기중') {
                    row.classList.add('active');
                }

                tableBody.appendChild(row);
            });
        }

        // 게임별 분석 계산
        function calculateGameAnalysis(game) {
            const bettingChoices = game.bettingChoices || {};
            let totalBettors = 0;
            let totalPoints = 0;
            let winners = 0;
            let distributedPoints = 0;

            // 각 선택별 통계 계산
            Object.keys(bettingChoices).forEach(choice => {
                const stats = bettingChoices[choice];
                totalBettors += stats.count || 0;
                totalPoints += stats.totalPoints || 0;

                // 예측결과가 있고, 이 선택이 맞았다면 승리자로 계산
                if (game.predictionResult && game.predictionResult === choice) {
                    winners += stats.count || 0;
                }
            });

            // 분배 포인트 계산 (승리자가 있을 때만)
            if (winners > 0 && game.predictionResult) {
                distributedPoints = Math.round(totalPoints / winners);
            }

            const winRate = totalBettors > 0 ? Math.round((winners / totalBettors) * 100) : 0;

            return {
                totalBettors,
                totalPoints,
                winners,
                distributedPoints,
                winRate
            };
        }

        // 요약 통계 업데이트
        function updateSummaryStats(games) {
            let totalGames = games.length;
            let totalBettors = 0;
            let totalPoints = 0;
            let totalWinners = 0;
            let totalDistributed = 0;
            let completedGames = 0;

            games.forEach(game => {
                const analysis = calculateGameAnalysis(game);
                totalBettors += analysis.totalBettors;
                totalPoints += analysis.totalPoints;
                totalWinners += analysis.winners;
                totalDistributed += analysis.distributedPoints;
                
                if (game.progressStatus === '경기끝') {
                    completedGames++;
                }
            });

            const avgWinRate = completedGames > 0 ? Math.round((totalWinners / totalBettors) * 100) : 0;

            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('totalBettors').textContent = totalBettors;
            document.getElementById('totalPoints').textContent = `₩${totalPoints.toLocaleString()}`;
            document.getElementById('totalWinners').textContent = totalWinners;
            document.getElementById('totalDistributed').textContent = `₩${totalDistributed.toLocaleString()}`;
            document.getElementById('avgWinRate').textContent = `${avgWinRate}%`;
        }

        // 사용자 상세 분석 표시
        function showUserDetails(gameNumber) {
            const game = currentGamesData.find(g => g.gameNumber === gameNumber);
            if (!game) return;

            const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
            const content = document.getElementById('userDetailContent');
            
            // 게임 분석 계산
            const analysis = calculateGameAnalysis(game);
            
            let html = `
                <h6>${gameNumber}경기 - ${game.matchup || '매치업 없음'}</h6>
                <p><strong>진행상태:</strong> ${game.progressStatus || '-'} | <strong>예측결과:</strong> ${game.predictionResult || '-'}</p>
                <p><strong>총 배팅포인트:</strong> ₩${analysis.totalPoints.toLocaleString()} | <strong>승리자 수:</strong> ${analysis.winners}명 | <strong>개인 분배 포인트:</strong> ₩${analysis.distributedPoints.toLocaleString()}</p>
                <hr>
                <div class="row">
            `;

            const bettingChoices = game.bettingChoices || {};
            const choices = ['1루', '2루', '3루', '홈런', '삼진', '아웃'];
            
            // 모든 선택을 한 줄에 표시 (6개 박스)
            html += '<div class="row mb-3">';
            choices.forEach(choice => {
                const stats = bettingChoices[choice] || { count: 0, totalPoints: 0 };
                const isCorrect = game.predictionResult === choice;
                const statusClass = game.predictionResult ? (isCorrect ? 'correct' : 'incorrect') : 'pending';
                
                html += `
                    <div class="col-md-2">
                        <div class="card h-100">
                            <div class="card-header text-center">
                                <span class="betting-choice ${statusClass}">${choice}</span>
                                ${game.predictionResult ? (isCorrect ? '<i class="fas fa-check text-success ms-2"></i>' : '<i class="fas fa-times text-danger ms-2"></i>') : ''}
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="mb-2">
                                    <small class="text-muted">배팅자 수</small>
                                    <div class="fw-bold">${stats.count}명</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">총 배팅포인트</small>
                                    <div class="fw-bold text-primary">₩${stats.totalPoints.toLocaleString()}</div>
                                </div>
                                ${game.predictionResult && isCorrect ? `
                                    <div class="mt-auto">
                                        <small class="text-muted">개인 분배 포인트</small>
                                        <div class="fw-bold text-success">₩${analysis.distributedPoints.toLocaleString()}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            html += '</div>';
            content.innerHTML = html;
            modal.show();
        }

        // 경기 목록 로드
        async function loadGameList() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/team-games/${today}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const gameSelect = document.getElementById('gameManagementSelect');
                    gameSelect.innerHTML = '<option value="">경기를 선택하세요</option>';
                    
                    result.data.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.gameNumber;
                        option.textContent = `${game.gameNumber}경기 - ${game.matchup || '매치업 없음'}`;
                        gameSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('경기 목록 로드 오류:', error);
            }
        }

        // 경기 선택 시 상태 업데이트
        document.addEventListener('DOMContentLoaded', function() {
            const gameSelect = document.getElementById('gameManagementSelect');
            if (gameSelect) {
                gameSelect.addEventListener('change', function() {
                    if (this.value) {
                        updateGameStatus();
                    } else {
                        document.getElementById('gameStatusInfo').innerHTML = 
                            '<p class="text-muted">경기를 선택하면 현재 상태를 확인할 수 있습니다.</p>';
                    }
                });
            }
        });



        // 페이지 로드 시 초기화
        window.onload = function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('logoutItem').style.display = 'block';
            }

            // 초기 데이터 로드
            loadTeamGamesData();
            updateUserStats();
            updateLoginStats();
            loadBettingData();
            loadGameBettingStats();
            updateGameAnalysisTable();
            
            // 실시간 업데이트 설정
            updateInterval = setInterval(() => {
                loadTeamGamesData();
                updateUserStats();
                updateLoginStats();
                loadBettingData();
                loadGameBettingStats();
                updateGameAnalysisTable();
            }, 2000); // 2초마다 업데이트
            
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                window.location.href = '/employee-login.html';
            });
        };

        // 페이지 언로드 시 인터벌 정리
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        };
    </script>
</body>
</html> 
</html> 
</html> 