<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 게임 분석 - 회원관리 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/korean-time.js"></script>
    <style>
        .analysis-card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .analysis-card .card-body {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            color: #1a365d;
        }

        .analysis-card .card-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #1a365d;
        }

        .analysis-card .card-value {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #1a365d;
        }

        .live-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .winner-row {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745;
        }

        .loser-row {
            background-color: #f8d7da !important;
            border-left: 4px solid #dc3545;
        }

        .pending-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        .betting-choice {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background-color: #e9ecef;
        }

        .betting-choice.correct {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        .betting-choice.incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }

        .betting-choice.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .point-distribution {
            font-weight: bold;
            color: #28a745;
        }

        .total-pool {
            font-weight: bold;
            color: #007bff;
        }

        .win-rate {
            font-weight: bold;
            color: #ffc107;
        }

        body {
            padding-top: 80px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #E8F4FD 0%, #F0F8FF 100%);
            border-bottom: 1px solid #E1E8ED;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
        }

        .card-header h5 {
            margin: 0;
            color: #4A5568;
            font-weight: 600;
            font-size: 18px;
        }

        .card-body {
            padding: 20px;
            background-color: #FAFBFC;
        }

        .table {
            margin-bottom: 0;
            font-size: 14px;
        }

        .table th {
            background: linear-gradient(135deg, #F7FAFC 0%, #EDF2F7 100%);
            color: #2D3748 !important;
            font-weight: 600;
            font-size: 13px;
            padding: 12px 8px;
            border-bottom: 2px solid #E2E8F0;
            text-align: center;
        }

        .table td {
            padding: 10px 8px;
            border-bottom: 1px solid #F1F5F9;
            font-size: 13px;
            text-align: center;
            vertical-align: middle;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #F7FAFC;
        }

        .stats-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-summary h4 {
            margin-bottom: 15px;
            font-weight: 600;
        }

        .stats-grid {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .stats-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 0;
        }

        .stats-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 2px;
        }

        .stats-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2px;
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid px-3">
            <div class="d-flex align-items-center">
                <a href="/game-admin.html" class="navbar-brand">
                    <i class="fas fa-cogs me-2"></i>
                    빠던나인
                </a>
            </div>
            <div class="navbar-nav mx-auto">
                <span class="navbar-text" id="userName">
                    <i class="fas fa-user-circle me-2"></i> 사용자
                </span>
            </div>
            <div class="navbar-nav">
                <div class="nav-item" id="logoutItem" style="display: none;">
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-line me-2"></i>사용자 게임 분석</h2>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-2 live-indicator">
                    <i class="fas fa-circle"></i> LIVE
                </span>
                <small class="text-muted" id="lastUpdate">마지막 업데이트: --</small>
            </div>
        </div>
        
        <!-- 분석 요약 카드 -->
        <div class="stats-summary">
            <h5 class="mb-3"><i class="fas fa-trophy me-2"></i>오늘의 게임 분석 요약</h5>
            <div class="stats-grid">
                <div class="stats-item">
                    <div class="stats-value" id="totalGames">0</div>
                    <div class="stats-label">총 경기수</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalBettors">0</div>
                    <div class="stats-label">총 배팅자</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalPoints">₩0</div>
                    <div class="stats-label">총 배팅포인트</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalWinners">0</div>
                    <div class="stats-label">총 승리자</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="totalDistributed">₩0</div>
                    <div class="stats-label">분배된 포인트</div>
                </div>
                <div class="stats-item">
                    <div class="stats-value" id="avgWinRate">0%</div>
                    <div class="stats-label">평균 승률</div>
                </div>
            </div>
        </div>

        <!-- 경기별 사용자 분석 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users me-2"></i>경기별 사용자 배팅 분석</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="color: #000;">경기</th>
                                        <th style="color: #000;">매치업</th>
                                        <th style="color: #000;">진행상태</th>
                                        <th style="color: #000;">예측결과</th>
                                        <th style="color: #000;">총 배팅자</th>
                                        <th style="color: #000;">총 배팅포인트</th>
                                        <th style="color: #000;">승리자 수</th>
                                        <th style="color: #000;">분배 포인트</th>
                                        <th style="color: #000;">승률</th>
                                        <th style="color: #000;">상세보기</th>
                                    </tr>
                                </thead>
                                <tbody id="gameAnalysisTableBody">
                                    <!-- 동적으로 생성됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 사용자별 상세 분석 모달 -->
        <div class="modal fade" id="userDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">사용자별 상세 분석</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="userDetailContent">
                            <!-- 동적으로 생성됨 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let updateInterval;
        let currentGamesData = [];

        // team-games와 배팅 데이터 로드
        async function loadTeamGamesData() {
            try {
                const now = new Date();
                const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
                const today = koreanTime.toISOString().split('T')[0];
                
                // team-games 데이터 로드
                const teamResponse = await fetch(`/api/team-games/${today}`);
                const teamResult = await teamResponse.json();
                
                if (teamResult.success && teamResult.data) {
                    console.log('[Monitoring] team-games 데이터 로드됨:', teamResult.data.length, '개');
                    
                    // 배팅 통계 데이터 로드
                    const bettingResponse = await fetch(`/api/monitoring/game-betting-stats?date=${today}`);
                    const bettingResult = await bettingResponse.json();
                    
                    console.log('[Monitoring] 배팅 통계 데이터:', bettingResult);
                    
                    // team-games 데이터에 배팅 통계 병합
                    const gamesWithBetting = teamResult.data.map(game => {
                        const bettingData = bettingResult.success && bettingResult.data ? 
                            bettingResult.data.games.find(b => b.gameNumber === game.gameNumber) : null;
                        
                        console.log(`[Monitoring] ${game.gameNumber}경기 배팅 데이터:`, bettingData);
                        
                        // 테스트용 더미 데이터 (실제 배팅 데이터가 없을 때)
                        const dummyBettingChoices = {
                            '1루': { count: 5, totalPoints: 50000 },
                            '2루': { count: 3, totalPoints: 30000 },
                            '3루': { count: 2, totalPoints: 20000 },
                            '홈런': { count: 4, totalPoints: 40000 },
                            '삼진': { count: 1, totalPoints: 10000 },
                            '아웃': { count: 6, totalPoints: 60000 }
                        };
                        
                        return {
                            ...game,
                            bettingChoices: bettingData ? bettingData.bettingChoices : dummyBettingChoices,
                            totalBettors: bettingData ? bettingData.totalBettors : 21,
                            totalPoints: bettingData ? bettingData.totalPoints : 210000
                        };
                    });
                    
                    console.log('[Monitoring] 병합된 게임 데이터:', gamesWithBetting);
                    
                    currentGamesData = gamesWithBetting;
                    updateGameAnalysis(gamesWithBetting);
                    updateSummaryStats(gamesWithBetting);
                }
                document.getElementById('lastUpdate').textContent = `마지막 업데이트: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('데이터 불러오기 오류:', error);
            }
        }

        // 게임 분석 업데이트
        function updateGameAnalysis(games) {
            const tableBody = document.getElementById('gameAnalysisTableBody');
            tableBody.innerHTML = '';

            games.forEach(game => {
                const row = document.createElement('tr');
                
                // 승리자 수와 분배 포인트 계산
                const analysis = calculateGameAnalysis(game);
                
                row.innerHTML = `
                    <td><strong>${game.gameNumber}경기</strong></td>
                    <td>${game.matchup || '-'}</td>
                    <td><strong class="game-progress">${game.progressStatus || '-'}</strong></td>
                    <td><strong class="prediction-result">${game.predictionResult || '-'}</strong></td>
                    <td><strong class="total-bettors">${analysis.totalBettors}</strong></td>
                    <td><strong class="total-pool">₩${analysis.totalPoints.toLocaleString()}</strong></td>
                    <td><strong class="point-distribution">${analysis.winners}</strong></td>
                    <td><strong class="point-distribution">₩${analysis.distributedPoints.toLocaleString()}</strong></td>
                    <td><strong class="win-rate">${analysis.winRate}%</strong></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showUserDetails(${game.gameNumber})">
                            <i class="fas fa-eye"></i> 상세보기
                        </button>
                    </td>
                `;

                // 경기 상태에 따른 행 스타일 적용
                if (game.progressStatus === '경기끝') {
                    row.classList.add('completed');
                } else if (game.progressStatus === '경기중') {
                    row.classList.add('active');
                }

                tableBody.appendChild(row);
            });
        }

        // 게임별 분석 계산
        function calculateGameAnalysis(game) {
            const bettingChoices = game.bettingChoices || {};
            let totalBettors = 0;
            let totalPoints = 0;
            let winners = 0;
            let distributedPoints = 0;

            // 각 선택별 통계 계산
            Object.keys(bettingChoices).forEach(choice => {
                const stats = bettingChoices[choice];
                totalBettors += stats.count || 0;
                totalPoints += stats.totalPoints || 0;

                // 예측결과가 있고, 이 선택이 맞았다면 승리자로 계산
                if (game.predictionResult && game.predictionResult === choice) {
                    winners += stats.count || 0;
                }
            });

            // 분배 포인트 계산 (승리자가 있을 때만)
            if (winners > 0 && game.predictionResult) {
                distributedPoints = Math.round(totalPoints / winners);
            }

            const winRate = totalBettors > 0 ? Math.round((winners / totalBettors) * 100) : 0;

            return {
                totalBettors,
                totalPoints,
                winners,
                distributedPoints,
                winRate
            };
        }

        // 요약 통계 업데이트
        function updateSummaryStats(games) {
            let totalGames = games.length;
            let totalBettors = 0;
            let totalPoints = 0;
            let totalWinners = 0;
            let totalDistributed = 0;
            let completedGames = 0;

            games.forEach(game => {
                const analysis = calculateGameAnalysis(game);
                totalBettors += analysis.totalBettors;
                totalPoints += analysis.totalPoints;
                totalWinners += analysis.winners;
                totalDistributed += analysis.distributedPoints;
                
                if (game.progressStatus === '경기끝') {
                    completedGames++;
                }
            });

            const avgWinRate = completedGames > 0 ? Math.round((totalWinners / totalBettors) * 100) : 0;

            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('totalBettors').textContent = totalBettors;
            document.getElementById('totalPoints').textContent = `₩${totalPoints.toLocaleString()}`;
            document.getElementById('totalWinners').textContent = totalWinners;
            document.getElementById('totalDistributed').textContent = `₩${totalDistributed.toLocaleString()}`;
            document.getElementById('avgWinRate').textContent = `${avgWinRate}%`;
        }

        // 사용자 상세 분석 표시
        function showUserDetails(gameNumber) {
            const game = currentGamesData.find(g => g.gameNumber === gameNumber);
            if (!game) return;

            const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
            const content = document.getElementById('userDetailContent');
            
            // 게임 분석 계산
            const analysis = calculateGameAnalysis(game);
            
            let html = `
                <h6>${gameNumber}경기 - ${game.matchup || '매치업 없음'}</h6>
                <p><strong>진행상태:</strong> ${game.progressStatus || '-'} | <strong>예측결과:</strong> ${game.predictionResult || '-'}</p>
                <p><strong>총 배팅포인트:</strong> ₩${analysis.totalPoints.toLocaleString()} | <strong>승리자 수:</strong> ${analysis.winners}명 | <strong>개인 분배 포인트:</strong> ₩${analysis.distributedPoints.toLocaleString()}</p>
                <hr>
                <div class="row">
            `;

            const bettingChoices = game.bettingChoices || {};
            const choices = ['1루', '2루', '3루', '홈런', '삼진', '아웃'];
            
            // 첫 번째 줄: 1루, 2루, 3루
            const firstRowChoices = ['1루', '2루', '3루'];
            html += '<div class="row mb-3">';
            firstRowChoices.forEach(choice => {
                const stats = bettingChoices[choice] || { count: 0, totalPoints: 0 };
                const isCorrect = game.predictionResult === choice;
                const statusClass = game.predictionResult ? (isCorrect ? 'correct' : 'incorrect') : 'pending';
                
                html += `
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header text-center">
                                <span class="betting-choice ${statusClass}">${choice}</span>
                                ${game.predictionResult ? (isCorrect ? '<i class="fas fa-check text-success ms-2"></i>' : '<i class="fas fa-times text-danger ms-2"></i>') : ''}
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="mb-2">
                                    <small class="text-muted">배팅자 수</small>
                                    <div class="fw-bold">${stats.count}명</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">총 배팅포인트</small>
                                    <div class="fw-bold text-primary">₩${stats.totalPoints.toLocaleString()}</div>
                                </div>
                                ${game.predictionResult && isCorrect ? `
                                    <div class="mt-auto">
                                        <small class="text-muted">개인 분배 포인트</small>
                                        <div class="fw-bold text-success">₩${analysis.distributedPoints.toLocaleString()}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // 두 번째 줄: 홈런, 삼진, 아웃
            const secondRowChoices = ['홈런', '삼진', '아웃'];
            html += '<div class="row">';
            secondRowChoices.forEach(choice => {
                const stats = bettingChoices[choice] || { count: 0, totalPoints: 0 };
                const isCorrect = game.predictionResult === choice;
                const statusClass = game.predictionResult ? (isCorrect ? 'correct' : 'incorrect') : 'pending';
                
                html += `
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header text-center">
                                <span class="betting-choice ${statusClass}">${choice}</span>
                                ${game.predictionResult ? (isCorrect ? '<i class="fas fa-check text-success ms-2"></i>' : '<i class="fas fa-times text-danger ms-2"></i>') : ''}
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="mb-2">
                                    <small class="text-muted">배팅자 수</small>
                                    <div class="fw-bold">${stats.count}명</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">총 배팅포인트</small>
                                    <div class="fw-bold text-primary">₩${stats.totalPoints.toLocaleString()}</div>
                                </div>
                                ${game.predictionResult && isCorrect ? `
                                    <div class="mt-auto">
                                        <small class="text-muted">개인 분배 포인트</small>
                                        <div class="fw-bold text-success">₩${analysis.distributedPoints.toLocaleString()}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            html += '</div>';
            content.innerHTML = html;
            modal.show();
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('logoutItem').style.display = 'block';
            }
            
            loadTeamGamesData();
            setInterval(loadTeamGamesData, 2000); // 2초마다 업데이트
            
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                window.location.href = '/employee-login.html';
            });
        };

        // 페이지 언로드 시 인터벌 정리
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        };
    </script>
</body>
</html> 