<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운영자 관리 - 빠던나인 게임</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
        }
        .auth-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .auth-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 30px;
            text-align: center;
        }
        .auth-body {
            padding: 30px;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .auth-switch {
            text-align: center;
            margin-top: 20px;
        }
        .auth-switch a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        /* 태블릿/노트북 최적화 스타일 */
        @media (min-width: 768px) {
            .auth-container {
                max-width: 800px;
                margin: 30px auto;
            }
            
            .auth-card {
                margin-bottom: 20px;
            }
            
            .form-label {
                font-weight: 500;
                margin-bottom: 8px;
            }
            
            .form-control, .form-select {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 16px;
            }
            
            .input-group .btn {
                padding: 10px 12px;
            }
        }
        
        /* 모바일 최적화 */
        @media (max-width: 767px) {
            .auth-container {
                max-width: 100%;
                margin: 20px 15px;
            }
            
            .row .col-md-6 {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-container">
            <!-- 로그인 폼 -->
            <div class="card auth-card" id="loginForm">
                <div class="auth-header">
                    <h3><i class="fas fa-user-shield me-2"></i>운영자 로그인</h3>
                    <p class="mb-0">빠던나인 게임 운영 시스템</p>
                </div>
                <div class="auth-body">
                    <form id="loginFormElement">
                                                 <div class="mb-3">
                             <label for="loginUsername" class="form-label">아이디</label>
                             <input type="text" class="form-control" id="loginUsername" autocomplete="username" required>
                         </div>
                                                 <div class="mb-3">
                             <label for="loginPassword" class="form-label">비밀번호</label>
                             <div class="input-group">
                                 <input type="password" class="form-control" id="loginPassword" autocomplete="current-password" required>
                                 <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('loginPassword')">
                                     <i class="fas fa-eye" id="loginPasswordIcon"></i>
                                 </button>
                             </div>
                         </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>로그인
                        </button>
                    </form>
                    <div class="auth-switch">
                        <a href="#" onclick="showRegisterForm()">운영자 계정이 없으신가요? 등록하기</a>
                    </div>
                </div>
            </div>

            <!-- 등록 폼 -->
            <div class="card auth-card" id="registerForm" style="display: none;">
                <div class="auth-header">
                    <h3><i class="fas fa-user-plus me-2"></i>운영자 등록</h3>
                    <p class="mb-0">새로운 운영자 계정을 생성합니다</p>
                </div>
                <div class="auth-body">
                    <form id="registerFormElement">
                        <!-- 첫 번째 줄: 아이디, 이름 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="registerUsername" class="form-label">아이디 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="registerUsername" autocomplete="username" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="checkUsernameDuplicate()">
                                        중복확인
                                    </button>
                                </div>
                                <div class="invalid-feedback" id="usernameFeedback">
                                    아이디를 입력해주세요.
                                </div>
                                <div class="valid-feedback" id="usernameValidFeedback">
                                    사용 가능한 아이디입니다.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="registerName" class="form-label">이름 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="registerName" autocomplete="name" required>
                            </div>
                        </div>

                        <!-- 두 번째 줄: 비밀번호, 비밀번호 확인 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="registerPassword" class="form-label">비밀번호 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="registerPassword" autocomplete="new-password" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('registerPassword')">
                                        <i class="fas fa-eye" id="registerPasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="registerPasswordConfirm" class="form-label">비밀번호 확인 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="registerPasswordConfirm" autocomplete="new-password" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('registerPasswordConfirm')">
                                        <i class="fas fa-eye" id="registerPasswordConfirmIcon"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback" id="passwordConfirmFeedback">
                                    비밀번호가 일치하지 않습니다.
                                </div>
                            </div>
                        </div>

                        <!-- 세 번째 줄: 부서, 직책 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="registerDepartment" class="form-label">부서 <span class="text-danger">*</span></label>
                                <select class="form-select" id="registerDepartment" required>
                                    <option value="">부서를 선택하세요</option>
                                    <option value="운영팀">운영팀</option>
                                    <option value="기술팀">기술팀</option>
                                    <option value="마케팅팀">마케팅팀</option>
                                    <option value="고객지원팀">고객지원팀</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="registerPosition" class="form-label">직책 <span class="text-danger">*</span></label>
                                <select class="form-select" id="registerPosition" required>
                                    <option value="">직책을 선택하세요</option>
                                    <option value="팀장">팀장</option>
                                    <option value="대리">대리</option>
                                    <option value="주임">주임</option>
                                    <option value="사원">사원</option>
                                    <option value="인턴">인턴</option>
                                </select>
                            </div>
                        </div>

                        <!-- 네 번째 줄: 이메일 -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="registerEmail" class="form-label">이메일</label>
                                <input type="email" class="form-control" id="registerEmail" autocomplete="email">
                            </div>
                        </div>

                        <!-- 다섯 번째 줄: 전화번호, 전화번호 확인 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="registerPhone" class="form-label">전화번호 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="tel" class="form-control" id="registerPhone" placeholder="010-1234-5678" autocomplete="tel" required>
                                    <button class="btn btn-outline-primary" type="button" onclick="sendVerificationCode()" id="sendCodeBtn">
                                        인증번호 발송
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="registerPhoneConfirm" class="form-label">전화번호 확인 <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="registerPhoneConfirm" placeholder="010-1234-5678" autocomplete="tel" required readonly>
                            </div>
                        </div>

                        <!-- 전화번호 인증 섹션 -->
                        <div class="row mb-3" id="verificationSection" style="display: none;">
                            <div class="col-12">
                                <label for="verificationCode" class="form-label">인증번호 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="verificationCode" placeholder="6자리 숫자" maxlength="6" required>
                                    <button class="btn btn-outline-success" type="button" onclick="verifyCode()" id="verifyCodeBtn">
                                        인증확인
                                    </button>
                                </div>
                                <div class="invalid-feedback" id="verificationFeedback">
                                    인증번호를 입력해주세요.
                                </div>
                                <div class="valid-feedback" id="verificationValidFeedback">
                                    인증이 완료되었습니다.
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-user-plus me-2"></i>등록하기
                        </button>
                    </form>
                    <div class="auth-switch">
                        <a href="#" onclick="showLoginForm()">이미 계정이 있으신가요? 로그인하기</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 비밀번호 확인 실시간 검증
            document.getElementById('registerPassword').addEventListener('input', validatePasswordConfirm);
            document.getElementById('registerPasswordConfirm').addEventListener('input', validatePasswordConfirm);
            
            // 전화번호 자동 형식 변환
            document.getElementById('registerPhone').addEventListener('input', formatPhoneNumber);
            
            // 폼 제출 이벤트
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('registerFormElement').addEventListener('submit', handleRegister);
        });

        // 로그인 폼 표시
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        // 등록 폼 표시
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // 비밀번호 확인 실시간 검증
        function validatePasswordConfirm() {
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const feedback = document.getElementById('passwordConfirmFeedback');
            
            if (passwordConfirm === '') {
                feedback.style.display = 'none';
                document.getElementById('registerPasswordConfirm').classList.remove('is-invalid');
                return;
            }
            
            if (password === passwordConfirm) {
                feedback.style.display = 'none';
                document.getElementById('registerPasswordConfirm').classList.remove('is-invalid');
                document.getElementById('registerPasswordConfirm').classList.add('is-valid');
            } else {
                feedback.style.display = 'block';
                document.getElementById('registerPasswordConfirm').classList.remove('is-valid');
                document.getElementById('registerPasswordConfirm').classList.add('is-invalid');
            }
        }

        // 로그인 처리
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/operator/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 로그인 성공 시 로컬 스토리지에 정보 저장
                    localStorage.setItem('operatorLoginStatus', 'loggedIn');
                    localStorage.setItem('operatorUserInfo', JSON.stringify(result.data));
                    
                    console.log('로그인 성공 - 로컬 스토리지 저장 완료');
                    console.log('저장된 정보:', localStorage.getItem('operatorLoginStatus'), localStorage.getItem('operatorUserInfo'));
                    
                    // 약간의 지연 후 index.html로 이동 (로컬 스토리지 저장 완료 보장)
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 100);
                } else {
                    alert(result.message || '로그인에 실패했습니다.');
                }
            } catch (error) {
                console.error('로그인 오류:', error);
                alert('로그인 처리 중 오류가 발생했습니다.');
            }
        }

        // 등록 처리
        async function handleRegister(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const name = document.getElementById('registerName').value;
            const department = document.getElementById('registerDepartment').value;
            const position = document.getElementById('registerPosition').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;

            // 비밀번호 확인 검증
            if (password !== passwordConfirm) {
                alert('비밀번호가 일치하지 않습니다.');
                return;
            }

            // 아이디 중복 체크 완료 여부 확인
            const usernameInput = document.getElementById('registerUsername');
            if (!usernameInput.classList.contains('is-valid')) {
                alert('아이디 중복 확인을 완료해주세요.');
                return;
            }

            // 부서와 직책 선택 여부 확인
            if (!department || !position) {
                alert('부서와 직책을 선택해주세요.');
                return;
            }

            // 전화번호 인증 완료 여부 확인
            if (!phoneVerified) {
                alert('전화번호 인증을 완료해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/operator/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        name,
                        department,
                        position,
                        email,
                        phone
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('운영자 등록이 완료되었습니다!');
                    showLoginForm(); // 로그인 폼으로 이동
                } else {
                    alert(result.message || '등록에 실패했습니다.');
                }
            } catch (error) {
                console.error('등록 오류:', error);
                alert('등록 처리 중 오류가 발생했습니다.');
            }
        }

        // 전화번호 인증 관련 변수
        let verificationCode = null;
        let phoneVerified = false;

        // 전화번호 자동 형식 변환 및 확인란 자동 입력
        function formatPhoneNumber(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            
            if (value.length <= 3) {
                e.target.value = value;
            } else if (value.length <= 7) {
                e.target.value = value.slice(0, 3) + '-' + value.slice(3);
            } else {
                e.target.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }
            
            // 전화번호 확인란에 자동으로 입력
            document.getElementById('registerPhoneConfirm').value = e.target.value;
        }

        // 전화번호 인증번호 발송
        async function sendVerificationCode() {
            const phone = document.getElementById('registerPhone').value;
            
            // 전화번호 형식 검증
            if (!phone || !/^01[0-9]-\d{3,4}-\d{4}$/.test(phone)) {
                alert('올바른 전화번호 형식을 입력해주세요. (예: 010-1234-5678)');
                return;
            }

            try {
                // 실제 SMS 발송 대신 시뮬레이션 (개발용)
                const code = Math.floor(100000 + Math.random() * 900000); // 6자리 랜덤 숫자
                verificationCode = code.toString();
                
                // 인증번호 발송 성공
                alert(`인증번호가 발송되었습니다: ${code}\n\n※ 실제 운영에서는 SMS로 발송됩니다.`);
                
                // 인증번호 입력 섹션 표시
                document.getElementById('verificationSection').style.display = 'block';
                
                // 발송 버튼 비활성화
                document.getElementById('sendCodeBtn').disabled = true;
                document.getElementById('sendCodeBtn').textContent = '재발송 (60초)';
                
                // 60초 후 재발송 가능
                let countdown = 60;
                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        document.getElementById('sendCodeBtn').textContent = `재발송 (${countdown}초)`;
                    } else {
                        document.getElementById('sendCodeBtn').disabled = false;
                        document.getElementById('sendCodeBtn').textContent = '재발송';
                        clearInterval(timer);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('인증번호 발송 오류:', error);
                alert('인증번호 발송에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 인증번호 확인
        function verifyCode() {
            const inputCode = document.getElementById('verificationCode').value;
            
            if (!inputCode) {
                document.getElementById('verificationFeedback').textContent = '인증번호를 입력해주세요.';
                document.getElementById('verificationFeedback').style.display = 'block';
                document.getElementById('verificationCode').classList.add('is-invalid');
                return;
            }
            
            if (inputCode === verificationCode) {
                // 인증 성공
                phoneVerified = true;
                document.getElementById('verificationFeedback').style.display = 'none';
                document.getElementById('verificationCode').classList.remove('is-invalid');
                document.getElementById('verificationCode').classList.add('is-valid');
                document.getElementById('verificationValidFeedback').style.display = 'block';
                
                // 인증 완료 후 버튼 비활성화
                document.getElementById('verifyCodeBtn').disabled = true;
                document.getElementById('verifyCodeBtn').textContent = '인증완료';
                document.getElementById('verifyCodeBtn').classList.remove('btn-outline-success');
                document.getElementById('verifyCodeBtn').classList.add('btn-success');
                
                alert('전화번호 인증이 완료되었습니다!');
            } else {
                // 인증 실패
                document.getElementById('verificationFeedback').textContent = '인증번호가 일치하지 않습니다.';
                document.getElementById('verificationFeedback').style.display = 'block';
                document.getElementById('verificationCode').classList.remove('is-valid');
                document.getElementById('verificationCode').classList.add('is-invalid');
                document.getElementById('verificationValidFeedback').style.display = 'none';
            }
        }

        // 비밀번호 보기/숨기기 토글
        function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const iconElement = document.getElementById(fieldId + 'Icon');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                iconElement.className = 'fas fa-eye-slash';
                iconElement.title = '비밀번호 숨기기';
            } else {
                passwordField.type = 'password';
                iconElement.className = 'fas fa-eye';
                iconElement.title = '비밀번호 보기';
            }
        }

        // 아이디 중복 체크
        async function checkUsernameDuplicate() {
            const username = document.getElementById('registerUsername').value;
            const feedback = document.getElementById('usernameFeedback');
            const validFeedback = document.getElementById('usernameValidFeedback');

            if (username === '') {
                feedback.textContent = '아이디를 입력해주세요.';
                feedback.style.display = 'block';
                document.getElementById('registerUsername').classList.add('is-invalid');
                validFeedback.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/operator/check-username?username=${username}`);
                const result = await response.json();

                if (result.success && !result.isDuplicate) {
                    // 사용 가능한 아이디
                    feedback.style.display = 'none';
                    document.getElementById('registerUsername').classList.remove('is-invalid');
                    document.getElementById('registerUsername').classList.add('is-valid');
                    validFeedback.style.display = 'block';
                } else {
                    // 이미 사용 중인 아이디
                    feedback.textContent = result.message || '이미 사용 중인 아이디입니다.';
                    feedback.style.display = 'block';
                    document.getElementById('registerUsername').classList.remove('is-valid');
                    document.getElementById('registerUsername').classList.add('is-invalid');
                    validFeedback.style.display = 'none';
                }
            } catch (error) {
                console.error('아이디 중복 체크 오류:', error);
                feedback.textContent = '아이디 중복 체크에 실패했습니다.';
                feedback.style.display = 'block';
                document.getElementById('registerUsername').classList.remove('is-valid');
                document.getElementById('registerUsername').classList.add('is-invalid');
                validFeedback.style.display = 'none';
            }
        }
    </script>
</body>
</html>
