<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운영자관리 - 빠던나인 게임 운영 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .operator-card {
            transition: transform 0.2s;
        }
        .operator-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .search-filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        .btn-action {
            margin: 2px;
        }
        .pagination-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .role-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 헤더 -->
        <div class="row bg-success text-white p-3">
            <div class="col">
                <h1><i class="fas fa-user-cog me-2"></i>운영자관리</h1>
                <p class="mb-0">게임 운영 시스템 운영자 정보를 관리합니다.</p>
            </div>
            <div class="col-auto">
                <div id="loginStatus" style="display: none;">
                    <div class="d-flex align-items-center">
                        <span class="me-3" id="operatorInfo"></span>
                        <button class="btn btn-light me-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>로그아웃
                        </button>
                    </div>
                </div>
                <div id="loginForm">
                    <div class="d-flex align-items-center">
                        <input type="text" class="form-control me-2" id="loginUsername" placeholder="아이디" style="width: 120px;">
                        <input type="password" class="form-control me-2" id="loginPassword" placeholder="비밀번호" style="width: 120px;">
                        <button class="btn btn-light me-2" onclick="login()">
                            <i class="fas fa-sign-in-alt me-1"></i>로그인
                        </button>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-warning me-2" onclick="clearSession()">
                            <i class="fas fa-broom me-1"></i>세션 정리
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="clearAllSessions()">
                            <i class="fas fa-trash me-1"></i>모든 세션 정리
                        </button>
                        <small class="text-light d-block mt-1">로그인 문제 시 사용</small>
                    </div>
                </div>
                <button class="btn btn-light" onclick="location.href='index.html'">
                    <i class="fas fa-home me-1"></i>홈으로
                </button>
            </div>
        </div>

        <!-- 할당된 경기 정보 (로그인 후 표시) -->
        <div class="row mt-3" id="assignedGamesRow" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-gamepad me-2"></i>할당된 경기</h5>
                    </div>
                    <div class="card-body">
                        <div id="assignedGamesInfo">
                            <!-- 할당된 경기 정보가 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="row mt-3" id="statsRow">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 id="totalOperators">0</h3>
                            <p class="mb-0">전체 운영자</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-cog fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 id="approvedOperators">0</h3>
                            <p class="mb-0">승인된 운영자</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 id="pendingOperators">0</h3>
                            <p class="mb-0">승인 대기</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h3 id="loggedInOperators">0</h3>
                            <p class="mb-0">현재 접속</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검색 및 필터 -->
        <div class="search-filters">
            <div class="row">
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">검색</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="이름, 아이디, 이메일, 전화번호">
                </div>
                <div class="col-md-2">
                    <label for="departmentFilter" class="form-label">부서</label>
                    <select class="form-select" id="departmentFilter">
                        <option value="">전체</option>
                        <option value="게임운영">게임운영</option>
                        <option value="시스템관리">시스템관리</option>
                        <option value="고객지원">고객지원</option>
                        <option value="기타">기타</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="positionFilter" class="form-label">직책</label>
                    <select class="form-select" id="positionFilter">
                        <option value="">전체</option>
                        <option value="관리자">관리자</option>
                        <option value="운영자">운영자</option>
                        <option value="직원">직원</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="approvalFilter" class="form-label">승인상태</label>
                    <select class="form-select" id="approvalFilter">
                        <option value="">전체</option>
                        <option value="true">승인됨</option>
                        <option value="false">승인대기</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="loginFilter" class="form-label">접속상태</label>
                    <select class="form-select" id="loginFilter">
                        <option value="">전체</option>
                        <option value="true">접속중</option>
                        <option value="false">미접속</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-success w-100" onclick="loadOperators()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 액션 버튼 -->
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-success" onclick="showAddOperatorModal()">
                    <i class="fas fa-plus me-1"></i>새 운영자 등록
                </button>
                <button class="btn btn-warning" onclick="showBulkApprovalModal()">
                    <i class="fas fa-check-double me-1"></i>대량 승인
                </button>
                <button class="btn btn-info" onclick="exportOperators()">
                    <i class="fas fa-download me-1"></i>내보내기
                </button>
                <button class="btn btn-primary" onclick="showActiveSessions()">
                    <i class="fas fa-users me-1"></i>활성 세션 관리
                </button>
            </div>
        </div>

        <!-- 운영자 목록 테이블 -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>이름</th>
                        <th>아이디</th>
                        <th>이메일</th>
                        <th>부서</th>
                        <th>직책</th>
                        <th>역할</th>
                        <th>전화번호</th>
                        <th>승인상태</th>
                        <th>접속상태</th>
                        <th>활성상태</th>
                        <th>등록일</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="operatorTableBody">
                    <!-- 운영자 데이터가 여기에 로드됩니다 -->
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="row">
            <div class="col-md-6">
                <div class="pagination-info" id="paginationInfo">
                    총 0명의 운영자 중 0-0명 표시
                </div>
            </div>
            <div class="col-md-6">
                <nav aria-label="운영자 목록 페이지네이션">
                    <ul class="pagination justify-content-end" id="pagination">
                        <!-- 페이지네이션이 여기에 생성됩니다 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 운영자 등록/수정 모달 -->
    <div class="modal fade" id="operatorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="operatorModalTitle">새 운영자 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="operatorForm">
                        <input type="hidden" id="operatorId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="operatorName" class="form-label">이름 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="operatorName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="operatorUsername" class="form-label">아이디 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="operatorUsername" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="operatorPassword" class="form-label">비밀번호 <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="operatorPassword" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="operatorEmail" class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="operatorEmail">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="operatorDepartment" class="form-label">부서</label>
                                    <select class="form-select" id="operatorDepartment">
                                        <option value="">부서 선택</option>
                                        <option value="게임운영">게임운영</option>
                                        <option value="시스템관리">시스템관리</option>
                                        <option value="고객지원">고객지원</option>
                                        <option value="기타">기타</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="operatorPosition" class="form-label">직책</label>
                                    <select class="form-select" id="operatorPosition">
                                        <option value="">직책 선택</option>
                                        <option value="관리자">관리자</option>
                                        <option value="운영자">운영자</option>
                                        <option value="직원">직원</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="operatorRole" class="form-label">역할</label>
                                    <select class="form-select" id="operatorRole">
                                        <option value="operator">운영자</option>
                                        <option value="admin">관리자</option>
                                        <option value="supervisor">감독자</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="operatorPhone" class="form-label">전화번호</label>
                            <input type="tel" class="form-control" id="operatorPhone">
                        </div>
                        <div class="mb-3" id="approvalSection" style="display: none;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="operatorApproved">
                                <label class="form-check-label" for="operatorApproved">
                                    승인됨
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="operatorActive" checked>
                                <label class="form-check-label" for="operatorActive">
                                    활성 상태
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="saveOperator()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 대량 승인 모달 -->
    <div class="modal fade" id="bulkApprovalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">대량 승인/반려</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>선택된 <span id="selectedCount">0</span>명의 운영자를 처리하시겠습니까?</p>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="bulkApproval" id="bulkApprove" value="true" checked>
                        <label class="form-check-label" for="bulkApprove">
                            승인
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="bulkApproval" id="bulkReject" value="false">
                        <label class="form-check-label" for="bulkReject">
                            반려
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="processBulkApproval()">처리</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 경기 할당 모달 -->
    <div class="modal fade" id="gameAssignmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">경기 할당</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>운영자 정보</h6>
                        <p class="mb-1"><strong>이름:</strong> <span id="assignOperatorName"></span></p>
                        <p class="mb-1"><strong>아이디:</strong> <span id="assignOperatorUsername"></span></p>
                    </div>
                    
                    <div class="mb-3">
                        <h6>날짜 선택</h6>
                        <input type="date" class="form-control" id="assignGameDate">
                    </div>
                    
                    <div class="mb-3">
                        <h6>경기 목록</h6>
                        <div id="availableGamesList">
                            <!-- 사용 가능한 경기 목록이 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-success" onclick="saveGameAssignment()">할당 저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 활성 세션 관리 모달 -->
    <div class="modal fade" id="activeSessionsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i>활성 세션 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button class="btn btn-success" onclick="refreshActiveSessions()">
                            <i class="fas fa-sync-alt me-1"></i>새로고침
                        </button>
                        <span class="ms-3 text-muted">현재 로그인된 운영자들의 세션 정보를 관리합니다.</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>운영자명</th>
                                    <th>아이디</th>
                                    <th>역할</th>
                                    <th>세션 ID</th>
                                    <th>로그인 시간</th>
                                    <th>세션 지속시간</th>
                                    <th>로그인 횟수</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody id="activeSessionsTableBody">
                                <!-- 활성 세션 목록이 여기에 표시됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let selectedOperators = new Set();

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadOperators();
            checkLoginStatus(); // 로그인 상태 확인
        });

        // 통계 로드
        async function loadStats() {
            try {
                const response = await fetch('/api/operate-member/stats/overview');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('totalOperators').textContent = result.data.totalOperators;
                    document.getElementById('approvedOperators').textContent = result.data.approvedOperators;
                    document.getElementById('pendingOperators').textContent = result.data.pendingOperators;
                    document.getElementById('loggedInOperators').textContent = result.data.loggedInOperators;
                }
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }

        // 운영자 목록 로드
        async function loadOperators(page = 1) {
            try {
                const search = document.getElementById('searchInput').value;
                const department = document.getElementById('departmentFilter').value;
                const position = document.getElementById('positionFilter').value;
                const isApproved = document.getElementById('approvalFilter').value;
                const isLoggedIn = document.getElementById('loginFilter').value;

                const params = new URLSearchParams({
                    page: page,
                    limit: 10,
                    search: search,
                    department: department,
                    position: position,
                    isApproved: isApproved,
                    isLoggedIn: isLoggedIn
                });

                const response = await fetch(`/api/operate-member?${params}`);
                const result = await response.json();

                if (result.success) {
                    displayOperators(result.data);
                    displayPagination(result.pagination);
                    currentPage = result.pagination.currentPage;
                    totalPages = result.pagination.totalPages;
                } else {
                    alert('운영자 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('운영자 목록 로드 오류:', error);
                alert('운영자 목록을 불러오는데 실패했습니다.');
            }
        }

        // 운영자 목록 표시
        function displayOperators(operators) {
            const tbody = document.getElementById('operatorTableBody');
            tbody.innerHTML = '';

            operators.forEach(operator => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="operator-checkbox" value="${operator._id}" onchange="toggleOperatorSelection('${operator._id}')">
                    </td>
                    <td>${operator.name}</td>
                    <td>${operator.username}</td>
                    <td>${operator.email || '-'}</td>
                    <td>${operator.department || '-'}</td>
                    <td>${operator.position || '-'}</td>
                    <td>
                        <span class="badge ${getRoleBadgeClass(operator.role)} role-badge">
                            ${getRoleDisplayName(operator.role)}
                        </span>
                    </td>
                    <td>${operator.phone || '-'}</td>
                    <td>
                        <span class="badge ${operator.isApproved ? 'bg-success' : 'bg-warning'} status-badge">
                            ${operator.isApproved ? '승인됨' : '승인대기'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${operator.isLoggedIn ? 'bg-primary' : 'bg-secondary'} status-badge">
                            ${operator.isLoggedIn ? '접속중' : '미접속'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${operator.isActive ? 'bg-success' : 'bg-danger'} status-badge">
                            ${operator.isActive ? '활성' : '비활성'}
                        </span>
                    </td>
                    <td>${formatDate(operator.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editOperator('${operator._id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success btn-action" onclick="approveOperator('${operator._id}', ${!operator.isApproved})">
                            <i class="fas fa-${operator.isApproved ? 'times' : 'check'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info btn-action" onclick="assignGames('${operator._id}', '${operator.username}', '${operator.name}')">
                            <i class="fas fa-gamepad"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteOperator('${operator._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 역할 배지 클래스 반환
        function getRoleBadgeClass(role) {
            switch(role) {
                case 'admin': return 'bg-danger';
                case 'supervisor': return 'bg-warning';
                default: return 'bg-primary';
            }
        }

        // 역할 표시명 반환
        function getRoleDisplayName(role) {
            switch(role) {
                case 'admin': return '관리자';
                case 'supervisor': return '감독자';
                default: return '운영자';
            }
        }

        // 페이지네이션 표시
        function displayPagination(pagination) {
            const paginationElement = document.getElementById('pagination');
            const infoElement = document.getElementById('paginationInfo');
            
            // 정보 업데이트
            const start = (pagination.currentPage - 1) * pagination.limit + 1;
            const end = Math.min(pagination.currentPage * pagination.limit, pagination.totalCount);
            infoElement.textContent = `총 ${pagination.totalCount}명의 운영자 중 ${start}-${end}명 표시`;

            // 페이지네이션 버튼 생성
            paginationElement.innerHTML = '';
            
            // 이전 페이지 버튼
            if (pagination.currentPage > 1) {
                const prevLi = document.createElement('li');
                prevLi.className = 'page-item';
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadOperators(${pagination.currentPage - 1})">이전</a>`;
                paginationElement.appendChild(prevLi);
            }

            // 페이지 번호 버튼들
            const startPage = Math.max(1, pagination.currentPage - 2);
            const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadOperators(${i})">${i}</a>`;
                paginationElement.appendChild(li);
            }

            // 다음 페이지 버튼
            if (pagination.currentPage < pagination.totalPages) {
                const nextLi = document.createElement('li');
                nextLi.className = 'page-item';
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadOperators(${pagination.currentPage + 1})">다음</a>`;
                paginationElement.appendChild(nextLi);
            }
        }

        // 운영자 선택 토글
        function toggleOperatorSelection(operatorId) {
            if (selectedOperators.has(operatorId)) {
                selectedOperators.delete(operatorId);
            } else {
                selectedOperators.add(operatorId);
            }
            updateSelectAllCheckbox();
        }

        // 전체 선택 토글
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.operator-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedOperators.add(checkbox.value);
                } else {
                    selectedOperators.delete(checkbox.value);
                }
            });
        }

        // 전체 선택 체크박스 업데이트
        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.operator-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAllCheckbox.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        // 새 운영자 등록 모달 표시
        function showAddOperatorModal() {
            document.getElementById('operatorModalTitle').textContent = '새 운영자 등록';
            document.getElementById('operatorForm').reset();
            document.getElementById('operatorId').value = '';
            document.getElementById('approvalSection').style.display = 'none';
            document.getElementById('operatorPassword').required = true;
            
            const modal = new bootstrap.Modal(document.getElementById('operatorModal'));
            modal.show();
        }

        // 운영자 수정 모달 표시
        async function editOperator(operatorId) {
            try {
                const response = await fetch(`/api/operate-member/${operatorId}`);
                const result = await response.json();

                if (result.success) {
                    const operator = result.data;
                    
                    document.getElementById('operatorModalTitle').textContent = '운영자 정보 수정';
                    document.getElementById('operatorId').value = operator._id;
                    document.getElementById('operatorName').value = operator.name;
                    document.getElementById('operatorUsername').value = operator.username;
                    document.getElementById('operatorEmail').value = operator.email || '';
                    document.getElementById('operatorDepartment').value = operator.department || '';
                    document.getElementById('operatorPosition').value = operator.position || '';
                    document.getElementById('operatorRole').value = operator.role || 'operator';
                    document.getElementById('operatorPhone').value = operator.phone || '';
                    document.getElementById('operatorApproved').checked = operator.isApproved;
                    document.getElementById('operatorActive').checked = operator.isActive;
                    document.getElementById('operatorPassword').required = false;
                    document.getElementById('approvalSection').style.display = 'block';

                    const modal = new bootstrap.Modal(document.getElementById('operatorModal'));
                    modal.show();
                } else {
                    alert('운영자 정보를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('운영자 정보 로드 오류:', error);
                alert('운영자 정보를 불러오는데 실패했습니다.');
            }
        }

        // 운영자 저장
        async function saveOperator() {
            try {
                const operatorId = document.getElementById('operatorId').value;
                const operatorData = {
                    name: document.getElementById('operatorName').value,
                    username: document.getElementById('operatorUsername').value,
                    password: document.getElementById('operatorPassword').value,
                    email: document.getElementById('operatorEmail').value,
                    department: document.getElementById('operatorDepartment').value,
                    position: document.getElementById('operatorPosition').value,
                    role: document.getElementById('operatorRole').value,
                    phone: document.getElementById('operatorPhone').value
                };

                if (operatorId) {
                    // 수정
                    if (document.getElementById('operatorApproved').checked !== undefined) {
                        operatorData.isApproved = document.getElementById('operatorApproved').checked;
                    }
                    if (document.getElementById('operatorActive').checked !== undefined) {
                        operatorData.isActive = document.getElementById('operatorActive').checked;
                    }
                    
                    const response = await fetch(`/api/operate-member/${operatorId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(operatorData)
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('운영자 정보가 수정되었습니다.');
                        bootstrap.Modal.getInstance(document.getElementById('operatorModal')).hide();
                        loadOperators(currentPage);
                        loadStats();
                    } else {
                        alert(result.message || '운영자 정보 수정에 실패했습니다.');
                    }
                } else {
                    // 등록
                    const response = await fetch('/api/operate-member', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(operatorData)
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('운영자가 등록되었습니다.');
                        bootstrap.Modal.getInstance(document.getElementById('operatorModal')).hide();
                        loadOperators(currentPage);
                        loadStats();
                    } else {
                        alert(result.message || '운영자 등록에 실패했습니다.');
                    }
                }
            } catch (error) {
                console.error('운영자 저장 오류:', error);
                alert('운영자 저장에 실패했습니다.');
            }
        }

        // 운영자 승인/반려
        async function approveOperator(operatorId, isApproved) {
            try {
                const response = await fetch(`/api/operate-member/${operatorId}/approval`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isApproved })
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadOperators(currentPage);
                    loadStats();
                } else {
                    alert(result.message || '승인/반려 처리에 실패했습니다.');
                }
            } catch (error) {
                console.error('승인/반려 오류:', error);
                alert('승인/반려 처리에 실패했습니다.');
            }
        }

        // 운영자 삭제
        async function deleteOperator(operatorId) {
            if (!confirm('정말로 이 운영자를 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/operate-member/${operatorId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert('운영자가 삭제되었습니다.');
                    loadOperators(currentPage);
                    loadStats();
                } else {
                    alert(result.message || '운영자 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('운영자 삭제 오류:', error);
                alert('운영자 삭제에 실패했습니다.');
            }
        }

        // 대량 승인 모달 표시
        function showBulkApprovalModal() {
            if (selectedOperators.size === 0) {
                alert('선택된 운영자가 없습니다.');
                return;
            }
            
            document.getElementById('selectedCount').textContent = selectedOperators.size;
            const modal = new bootstrap.Modal(document.getElementById('bulkApprovalModal'));
            modal.show();
        }

        // 대량 승인/반려 처리
        async function processBulkApproval() {
            try {
                const isApproved = document.querySelector('input[name="bulkApproval"]:checked').value === 'true';
                
                const response = await fetch('/api/operate-member/bulk/approval', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operatorIds: Array.from(selectedOperators),
                        isApproved: isApproved
                    })
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    selectedOperators.clear();
                    loadOperators(currentPage);
                    loadStats();
                    bootstrap.Modal.getInstance(document.getElementById('bulkApprovalModal')).hide();
                } else {
                    alert(result.message || '대량 처리에 실패했습니다.');
                }
            } catch (error) {
                console.error('대량 처리 오류:', error);
                alert('대량 처리에 실패했습니다.');
            }
        }

        // 운영자 목록 내보내기
        function exportOperators() {
            // CSV 형식으로 내보내기 기능 구현
            alert('내보내기 기능은 추후 구현 예정입니다.');
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // 로그인 상태 확인 및 헤더 업데이트
        async function checkLoginStatus() {
            try {
                console.log('로그인 상태 확인 시작');
                
                // 로컬 스토리지에서 로그인 정보 확인
                const loginInfo = localStorage.getItem('operatorLoginInfo');
                console.log('로컬 스토리지 로그인 정보:', loginInfo);
                
                if (loginInfo) {
                    const operator = JSON.parse(loginInfo);
                    console.log('파싱된 운영자 정보:', operator);
                    console.log('운영자 ID:', operator._id);
                    
                    document.getElementById('operatorInfo').textContent = `${operator.username} (${operator.name})`;
                    document.getElementById('loginStatus').style.display = 'block';
                    document.getElementById('loginForm').style.display = 'none';

                    // 할당된 경기 정보 로드
                    console.log('할당된 경기 정보 로드 호출');
                    await loadAssignedGames(operator._id);
                    document.getElementById('assignedGamesRow').style.display = 'block';
                } else {
                    console.log('로그인 정보가 없습니다.');
                    document.getElementById('loginStatus').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('assignedGamesRow').style.display = 'none';
                }
            } catch (error) {
                console.error('로그인 상태 확인 오류:', error);
                document.getElementById('loginStatus').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('assignedGamesRow').style.display = 'none';
            }
        }

        // 로그인 처리
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('아이디와 비밀번호를 모두 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/operate-member/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();

                if (result.success) {
                    // 로그인 정보를 로컬 스토리지에 저장
                    localStorage.setItem('operatorLoginInfo', JSON.stringify(result.data));
                    
                    alert('로그인 성공!');
                    await checkLoginStatus(); // 로그인 후 상태 확인
                    
                    // 로그인 폼 초기화
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                } else if (result.code === 'DUPLICATE_LOGIN') {
                    // 중복 로그인 감지 - 강제 로그인 옵션 제공
                    handleDuplicateLogin(username, password, result.data);
                } else {
                    alert(result.message || '로그인에 실패했습니다.');
                }
            } catch (error) {
                console.error('로그인 오류:', error);
                alert('로그인에 실패했습니다.');
            }
        }

        // 중복 로그인 처리
        async function handleDuplicateLogin(username, password, duplicateData) {
            const lastLoginTime = new Date(duplicateData.lastLoginAt).toLocaleString('ko-KR');
            
            const shouldForceLogin = confirm(
                `이미 다른 곳에서 로그인되어 있습니다.\n\n` +
                `마지막 로그인: ${lastLoginTime}\n\n` +
                `기존 세션을 종료하고 새로운 로그인을 진행하시겠습니까?\n\n` +
                `(기존 세션은 자동으로 로그아웃됩니다)`
            );

            if (shouldForceLogin) {
                try {
                    const response = await fetch('/api/operate-member/force-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const result = await response.json();

                    if (result.success) {
                        // 로그인 정보를 로컬 스토리지에 저장
                        localStorage.setItem('operatorLoginInfo', JSON.stringify(result.data));
                        
                        alert('기존 세션을 종료하고 새로운 로그인이 성공했습니다!');
                        await checkLoginStatus(); // 로그인 후 상태 확인
                        
                        // 로그인 폼 초기화
                        document.getElementById('loginUsername').value = '';
                        document.getElementById('loginPassword').value = '';
                    } else {
                        alert(result.message || '강제 로그인에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('강제 로그인 오류:', error);
                    alert('강제 로그인에 실패했습니다.');
                }
            }
        }

        // 로그아웃 처리
        async function logout() {
            try {
                const loginInfo = localStorage.getItem('operatorLoginInfo');
                if (loginInfo) {
                    const operator = JSON.parse(loginInfo);
                    
                    // 서버에 로그아웃 요청
                    const response = await fetch('/api/operate-member/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: operator.username })
                    });
                    const result = await response.json();

                    if (result.success) {
                        console.log('서버 로그아웃 성공');
                    } else {
                        console.warn('서버 로그아웃 실패:', result.message);
                    }
                }
                
                // 로컬 스토리지에서 로그인 정보 삭제
                localStorage.removeItem('operatorLoginInfo');
                
                // UI 상태 업데이트
                document.getElementById('operatorInfo').textContent = '';
                document.getElementById('loginStatus').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('assignedGamesRow').style.display = 'none';
                
                console.log('로그아웃 완료');
                
            } catch (error) {
                console.error('로그아웃 오류:', error);
                // 오류가 발생해도 로컬 상태는 정리
                localStorage.removeItem('operatorLoginInfo');
                document.getElementById('operatorInfo').textContent = '';
                document.getElementById('loginStatus').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('assignedGamesRow').style.display = 'none';
            }
        }

        // 할당된 경기 정보 로드
        async function loadAssignedGames(operatorId) {
            try {
                console.log('할당된 경기 로드 시작, operatorId:', operatorId);
                
                // team-games 컬렉션에서 해당 운영자에게 할당된 경기 조회
                const response = await fetch(`/api/team-games/assigned/${operatorId}`);
                const result = await response.json();

                console.log('할당된 경기 조회 결과:', result);

                if (result.success) {
                    const gamesInfoDiv = document.getElementById('assignedGamesInfo');
                    gamesInfoDiv.innerHTML = ''; // 기존 내용 지우기
                    
                    if (result.data && result.data.length > 0) {
                        console.log('할당된 경기 수:', result.data.length);
                        
                        // 할당된 경기들을 날짜별로 그룹화
                        const gamesByDate = {};
                        result.data.forEach(game => {
                            if (!gamesByDate[game.date]) {
                                gamesByDate[game.date] = [];
                            }
                            gamesByDate[game.date].push(game);
                        });
                        
                        console.log('날짜별 경기 그룹화:', gamesByDate);
                        
                        // 각 날짜별로 경기 정보 표시
                        Object.keys(gamesByDate).forEach(date => {
                            const dateHeader = document.createElement('h6');
                            dateHeader.className = 'text-primary mb-2';
                            dateHeader.textContent = `날짜: ${formatDate(date)}`;
                            gamesInfoDiv.appendChild(dateHeader);
                            
                            gamesByDate[date].forEach(game => {
                                const gameInfo = document.createElement('div');
                                gameInfo.className = 'card mb-2';
                                gameInfo.innerHTML = `
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>경기 번호:</strong> ${game.gameNumber}경기<br>
                                                <strong>매치업:</strong> ${game.matchup}<br>
                                                <strong>시작 시간:</strong> ${game.startTime || '-'}<br>
                                                <strong>종료 시간:</strong> ${game.endTime || '-'}
                                            </div>
                                            <div class="col-md-6">
                                                <strong>경기 상태:</strong> 
                                                <span class="badge ${getGameStatusBadgeClass(game.gameStatus)}">${game.gameStatus}</span><br>
                                                <strong>진행 상태:</strong> 
                                                <span class="badge ${getProgressStatusBadgeClass(game.progressStatus)}">${game.progressStatus}</span><br>
                                                <strong>배팅 상태:</strong> ${game.bettingStart}/${game.bettingStop}<br>
                                                <strong>예측 결과:</strong> ${game.predictionResult || '-'}
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-primary" onclick="selectGame('${game.date}', ${game.gameNumber})" ${game.isSelected ? 'disabled' : ''}>
                                                <i class="fas fa-${game.isSelected ? 'check-circle' : 'check'} me-1"></i>${game.isSelected ? '선택됨' : '경기 선택'}
                                            </button>
                                            <button class="btn btn-sm btn-info" onclick="viewGameDetails('${game.date}', ${game.gameNumber})">
                                                <i class="fas fa-eye me-1"></i>상세보기
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="unassignGame('${game.date}', ${game.gameNumber})">
                                                <i class="fas fa-unlink me-1"></i>할당 해제
                                            </button>
                                        </div>
                                    </div>
                                `;
                                gamesInfoDiv.appendChild(gameInfo);
                            });
                        });

                        // 오늘 날짜의 할당된 경기가 있으면 gameNumber 1~5 자동 선택
                        const today = new Date().toISOString().split('T')[0];
                        const todayGames = gamesByDate[today] || [];
                        
                        console.log('오늘 날짜:', today);
                        console.log('오늘 할당된 경기:', todayGames);
                        
                        if (todayGames.length > 0) {
                            console.log('오늘 경기 자동 선택 시작');
                            
                            // gameNumber 1~5 순서대로 자동 선택
                            for (let gameNumber = 1; gameNumber <= 5; gameNumber++) {
                                const targetGame = todayGames.find(game => game.gameNumber === gameNumber);
                                if (targetGame && !targetGame.isSelected) {
                                    console.log(`경기 ${gameNumber} 자동 선택 실행`);
                                    const autoSelectResult = await autoSelectGame(targetGame.date, targetGame.gameNumber);
                                    console.log(`경기 ${gameNumber} 자동 선택 결과:`, autoSelectResult);
                                } else if (targetGame && targetGame.isSelected) {
                                    console.log(`경기 ${gameNumber}은 이미 선택됨`);
                                } else {
                                    console.log(`경기 ${gameNumber}은 할당되지 않음`);
                                }
                            }
                            
                            // 첫 번째 할당된 경기 정보 표시
                            const firstGame = todayGames[0];
                            if (firstGame) {
                                console.log('선택된 경기 정보 표시 시작');
                                await showSelectedGameInfo(firstGame);
                            }
                        } else {
                            console.log('오늘 할당된 경기가 없습니다.');
                        }
                    } else {
                        console.log('할당된 경기가 없습니다.');
                        gamesInfoDiv.innerHTML = '<p class="text-muted">할당된 경기가 없습니다.</p>';
                    }
                } else {
                    console.error('할당된 경기 조회 실패:', result.message);
                    alert('할당된 경기 정보를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('할당된 경기 정보 로드 오류:', error);
                alert('할당된 경기 정보를 불러오는데 실패했습니다.');
            }
        }

        // 경기 상태 배지 클래스 반환
        function getGameStatusBadgeClass(status) {
            switch(status) {
                case '정상게임': return 'bg-success';
                case '경기취소': return 'bg-danger';
                case '경기끝': return 'bg-secondary';
                default: return 'bg-primary';
            }
        }

        // 진행 상태 배지 클래스 반환
        function getProgressStatusBadgeClass(status) {
            switch(status) {
                case '경기전': return 'bg-warning';
                case '경기중': return 'bg-info';
                case '경기끝': return 'bg-success';
                case '경기취소': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // 경기 선택
        async function selectGame(date, gameNumber) {
            try {
                const response = await fetch(`/api/team-games/${date}/${gameNumber}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isSelected: true })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('경기가 선택되었습니다.');
                    // 할당된 경기 정보 새로고침
                    const loginInfo = localStorage.getItem('operatorLoginInfo');
                    if (loginInfo) {
                        const operator = JSON.parse(loginInfo);
                        await loadAssignedGames(operator._id);
                    }
                } else {
                    alert(result.message || '경기 선택에 실패했습니다.');
                }
            } catch (error) {
                console.error('경기 선택 오류:', error);
                alert('경기 선택에 실패했습니다.');
            }
        }

        // 경기 상세보기
        function viewGameDetails(date, gameNumber) {
            // 경기 상세 정보를 모달로 표시하는 기능 (추후 구현)
            alert(`경기 상세보기: ${date} ${gameNumber}경기`);
        }

        // 경기 할당 모달 표시
        async function assignGames(operatorId, username, name) {
            try {
                // 운영자 정보 설정
                document.getElementById('assignOperatorName').textContent = name;
                document.getElementById('assignOperatorUsername').textContent = username;
                
                // 운영자 ID를 모달에 저장 (숨겨진 필드로)
                const modal = document.getElementById('gameAssignmentModal');
                modal.dataset.operatorId = operatorId;
                
                // 오늘 날짜를 기본값으로 설정
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('assignGameDate').value = today;
                
                // 경기 목록 로드
                await loadAvailableGames(today);
                
                // 모달 표시
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
                
                // 날짜 변경 이벤트 리스너 추가
                document.getElementById('assignGameDate').addEventListener('change', async function() {
                    await loadAvailableGames(this.value);
                });
                
            } catch (error) {
                console.error('경기 할당 모달 표시 오류:', error);
                alert('경기 할당 모달을 표시하는데 실패했습니다.');
            }
        }

        // 사용 가능한 경기 목록 로드
        async function loadAvailableGames(date) {
            try {
                const response = await fetch(`/api/team-games/${date}`);
                const result = await response.json();

                if (result.success) {
                    const gamesListDiv = document.getElementById('availableGamesList');
                    gamesListDiv.innerHTML = '';

                    if (result.data && result.data.length > 0) {
                        result.data.forEach(game => {
                            const gameItem = document.createElement('div');
                            gameItem.className = 'card mb-2';
                            gameItem.innerHTML = `
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">${game.gameNumber}경기</h6>
                                            <p class="mb-1"><strong>매치업:</strong> ${game.matchup}</p>
                                            <p class="mb-1"><strong>시간:</strong> ${game.startTime || '-'} ~ ${game.endTime || '-'}</p>
                                            <p class="mb-1"><strong>상태:</strong> 
                                                <span class="badge ${getGameStatusBadgeClass(game.gameStatus)}">${game.gameStatus}</span>
                                            </p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="game_${game.gameNumber}" 
                                                       value="${game.gameNumber}"
                                                       data-date="${game.date}"
                                                       ${game.assignedOperator ? 'disabled' : ''}>
                                                <label class="form-check-label" for="game_${game.gameNumber}">
                                                    ${game.assignedOperator ? '이미 할당됨' : '할당'}
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            gamesListDiv.appendChild(gameItem);
                        });
                    } else {
                        gamesListDiv.innerHTML = '<p class="text-muted">해당 날짜에 경기가 없습니다.</p>';
                    }
                } else {
                    alert('경기 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('경기 목록 로드 오류:', error);
                alert('경기 목록을 불러오는데 실패했습니다.');
            }
        }

        // 경기 할당 저장
        async function saveGameAssignment() {
            try {
                const modal = document.getElementById('gameAssignmentModal');
                const operatorId = modal.dataset.operatorId;
                const operatorName = document.getElementById('assignOperatorName').textContent;
                const date = document.getElementById('assignGameDate').value;
                
                // 선택된 경기들 확인
                const selectedGames = [];
                const checkboxes = document.querySelectorAll('#availableGamesList input[type="checkbox"]:checked');
                
                checkboxes.forEach(checkbox => {
                    selectedGames.push({
                        gameNumber: checkbox.value,
                        date: checkbox.dataset.date
                    });
                });

                if (selectedGames.length === 0) {
                    alert('할당할 경기를 선택해주세요.');
                    return;
                }

                // 각 경기에 운영자 할당
                const assignmentPromises = selectedGames.map(async (game) => {
                    const response = await fetch(`/api/team-games/${game.date}/${game.gameNumber}/assign`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ operatorId: operatorId })
                    });
                    return response.json();
                });

                const results = await Promise.all(assignmentPromises);
                const successCount = results.filter(result => result.success).length;

                if (successCount > 0) {
                    alert(`${successCount}개 경기가 ${operatorName}에게 할당되었습니다.`);
                    
                    // 모달 닫기
                    bootstrap.Modal.getInstance(modal).hide();
                    
                    // 운영자 목록 새로고침
                    loadOperators(currentPage);
                } else {
                    alert('경기 할당에 실패했습니다.');
                }

            } catch (error) {
                console.error('경기 할당 저장 오류:', error);
                alert('경기 할당 저장에 실패했습니다.');
            }
        }

        // 경기 자동 선택
        async function autoSelectGame(date, gameNumber) {
            try {
                console.log(`경기 자동 선택 시작: ${date} ${gameNumber}경기`);
                
                const response = await fetch(`/api/team-games/${date}/${gameNumber}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isSelected: true })
                });
                
                const result = await response.json();
                console.log('경기 자동 선택 API 응답:', result);
                
                if (result.success) {
                    console.log(`경기 자동 선택 완료: ${date} ${gameNumber}경기`);
                    return true;
                } else {
                    console.error('경기 자동 선택 실패:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('경기 자동 선택 오류:', error);
                return false;
            }
        }

        // 선택된 경기 정보 표시
        async function showSelectedGameInfo(game) {
            try {
                console.log('선택된 경기 정보 표시 시작:', game);
                
                // 선택된 경기 정보를 상단에 표시
                const selectedGameInfo = document.createElement('div');
                selectedGameInfo.className = 'alert alert-success mb-3';
                selectedGameInfo.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1"><i class="fas fa-star me-2"></i>선택된 경기</h5>
                            <p class="mb-1"><strong>${game.gameNumber}경기:</strong> ${game.matchup}</p>
                            <p class="mb-0"><strong>시간:</strong> ${game.startTime || '-'} ~ ${game.endTime || '-'}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-success btn-lg" onclick="startBettingRoutine('${game.date}', ${game.gameNumber})">
                                <i class="fas fa-play me-2"></i>배팅 시작
                            </button>
                        </div>
                    </div>
                `;
                
                // 기존 선택된 경기 정보가 있으면 제거
                const existingInfo = document.querySelector('.alert-success');
                if (existingInfo) {
                    console.log('기존 선택된 경기 정보 제거');
                    existingInfo.remove();
                }
                
                // 새로운 선택된 경기 정보를 할당된 경기 섹션 위에 추가
                const assignedGamesRow = document.getElementById('assignedGamesRow');
                console.log('할당된 경기 섹션 찾기:', assignedGamesRow);
                
                if (assignedGamesRow && assignedGamesRow.parentNode) {
                    assignedGamesRow.parentNode.insertBefore(selectedGameInfo, assignedGamesRow);
                    console.log('선택된 경기 정보 표시 완료');
                } else {
                    console.error('할당된 경기 섹션을 찾을 수 없습니다.');
                }
                
            } catch (error) {
                console.error('선택된 경기 정보 표시 오류:', error);
            }
        }

        // 배팅 시작 루틴
        async function startBettingRoutine(date, gameNumber) {
            try {
                // 경기 상태 확인
                const response = await fetch(`/api/team-games/${date}/${gameNumber}`);
                const result = await response.json();
                
                if (result.success) {
                    const game = result.data;
                    
                    // 경기 상태에 따른 배팅 시작 처리
                    if (game.progressStatus === '경기전') {
                        // 배팅 시작 처리
                        await startBetting(date, gameNumber);
                    } else if (game.progressStatus === '경기중') {
                        // 경기 진행 중 - 배팅 중지 처리
                        await stopBetting(date, gameNumber);
                    } else if (game.progressStatus === '경기끝') {
                        // 경기 종료 - 결과 처리
                        await processGameResult(date, gameNumber);
                    } else {
                        alert(`현재 경기 상태: ${game.progressStatus}\n적절한 작업을 선택해주세요.`);
                    }
                } else {
                    alert('경기 정보를 불러오는데 실패했습니다.');
                }
                
            } catch (error) {
                console.error('배팅 시작 루틴 오류:', error);
                alert('배팅 시작 루틴 실행에 실패했습니다.');
            }
        }

        // 배팅 시작
        async function startBetting(date, gameNumber) {
            try {
                const response = await fetch(`/api/team-games/${date}/${gameNumber}/betting`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'start',
                        bettingStart: true,
                        bettingStop: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('배팅이 시작되었습니다!');
                    // 경기 상태를 '경기중'으로 변경
                    await updateGameProgress(date, gameNumber, '경기중');
                    // 할당된 경기 정보 새로고침
                    const loginInfo = localStorage.getItem('operatorLoginInfo');
                    if (loginInfo) {
                        const operator = JSON.parse(loginInfo);
                        await loadAssignedGames(operator._id);
                    }
                } else {
                    alert(result.message || '배팅 시작에 실패했습니다.');
                }
            } catch (error) {
                console.error('배팅 시작 오류:', error);
                alert('배팅 시작에 실패했습니다.');
            }
        }

        // 배팅 중지
        async function stopBetting(date, gameNumber) {
            try {
                const response = await fetch(`/api/team-games/${date}/${gameNumber}/betting`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'stop',
                        bettingStart: false,
                        bettingStop: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('배팅이 중지되었습니다!');
                    // 경기 상태를 '경기끝'으로 변경
                    await updateGameProgress(date, gameNumber, '경기끝');
                    // 할당된 경기 정보 새로고침
                    const loginInfo = localStorage.getItem('operatorLoginInfo');
                    if (loginInfo) {
                        const operator = JSON.parse(loginInfo);
                        await loadAssignedGames(operator._id);
                    }
                } else {
                    alert(result.message || '배팅 중지에 실패했습니다.');
                }
            } catch (error) {
                console.error('배팅 중지 오류:', error);
                alert('배팅 중지에 실패했습니다.');
            }
        }

        // 경기 진행 상태 업데이트
        async function updateGameProgress(date, gameNumber, progressStatus) {
            try {
                const response = await fetch(`/api/team-games/${date}/${gameNumber}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ progressStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`경기 진행 상태 업데이트 완료: ${progressStatus}`);
                    return true;
                } else {
                    console.error('경기 진행 상태 업데이트 실패:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('경기 진행 상태 업데이트 오류:', error);
                return false;
            }
        }

        // 경기 결과 처리
        async function processGameResult(date, gameNumber) {
            // 경기 결과 처리 로직 (추후 구현)
            alert('경기 결과 처리 기능은 추후 구현 예정입니다.');
        }

        // 경기 할당 해제
        async function unassignGame(date, gameNumber) {
            if (!confirm('정말로 이 경기의 할당을 해제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/team-games/${date}/${gameNumber}/unassign`, {
                    method: 'PUT'
                });
                const result = await response.json();

                if (result.success) {
                    alert('경기 할당이 해제되었습니다.');
                    // 할당된 경기 정보 새로고침
                    const loginInfo = localStorage.getItem('operatorLoginInfo');
                    if (loginInfo) {
                        const operator = JSON.parse(loginInfo);
                        await loadAssignedGames(operator._id);
                    }
                } else {
                    alert(result.message || '경기 할당 해제에 실패했습니다.');
                }
            } catch (error) {
                console.error('경기 할당 해제 오류:', error);
                alert('경기 할당 해제에 실패했습니다.');
            }
        }

        // 활성 세션 관리 모달 표시
        function showActiveSessions() {
            const modal = new bootstrap.Modal(document.getElementById('activeSessionsModal'));
            modal.show();
            refreshActiveSessions(); // 모달 표시 시 초기 상태 로드
        }

        // 활성 세션 목록 새로고침
        async function refreshActiveSessions() {
            try {
                const response = await fetch('/api/operate-member/sessions/active');
                const result = await response.json();

                if (result.success) {
                    displayActiveSessions(result.data);
                } else {
                    alert('활성 세션 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('활성 세션 목록 로드 오류:', error);
                alert('활성 세션 목록을 불러오는데 실패했습니다.');
            }
        }

        // 활성 세션 목록 표시
        function displayActiveSessions(sessions) {
            const tbody = document.getElementById('activeSessionsTableBody');
            tbody.innerHTML = '';

            if (sessions && sessions.length > 0) {
                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${session.name}</td>
                        <td>${session.username}</td>
                        <td>
                            <span class="badge ${getRoleBadgeClass(session.role)} role-badge">
                                ${getRoleDisplayName(session.role)}
                            </span>
                        </td>
                        <td>${session.sessionId}</td>
                        <td>${formatDate(session.lastLoginAt)}</td>
                        <td>${formatDuration(session.sessionAge)}</td>
                        <td>${session.loginCount}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="forceLogout('${session.sessionId}')">
                                <i class="fas fa-power-off"></i> 강제 로그아웃
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">활성 세션이 없습니다.</td></tr>';
            }
        }

        // 세션 지속 시간 포맷
        function formatDuration(minutes) {
            if (minutes === null || minutes === undefined) return '-';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours > 0) {
                return `${hours}시간 ${mins}분`;
            } else {
                return `${mins}분`;
            }
        }

        // 강제 로그아웃
        async function forceLogout(sessionId) {
            if (!confirm(`세션 ID ${sessionId}의 운영자를 강제 로그아웃하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/operate-member/force-logout/${sessionId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert(`세션 ID ${sessionId}의 운영자가 강제 로그아웃되었습니다.`);
                    refreshActiveSessions(); // 목록 새로고침
                } else {
                    alert(result.message || '강제 로그아웃에 실패했습니다.');
                }
            } catch (error) {
                console.error('강제 로그아웃 오류:', error);
                alert('강제 로그아웃에 실패했습니다.');
            }
        }

        // 세션 정리 (현재 로그인된 운영자의 세션만 제거)
        async function clearSession() {
            try {
                const username = document.getElementById('loginUsername').value;
                if (!username) {
                    alert('아이디를 입력해주세요.');
                    return;
                }
                
                if (!confirm(`운영자 "${username}"의 세션을 정리하시겠습니까?`)) {
                    return;
                }
                
                const response = await fetch(`/api/operate-member/session/clear/${username}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('세션이 성공적으로 정리되었습니다. 다시 로그인해주세요.');
                    // 로그인 폼 초기화
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                } else {
                    alert(result.message || '세션 정리에 실패했습니다.');
                }
            } catch (error) {
                console.error('세션 정리 오류:', error);
                alert('세션 정리에 실패했습니다.');
            }
        }

        // 모든 세션 정리 (모든 운영자의 세션 제거)
        async function clearAllSessions() {
            if (!confirm('모든 운영자의 세션을 정리하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }

            try {
                const response = await fetch('/api/operate-member/session/clear-all', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('모든 운영자의 세션이 정리되었습니다.');
                    // 로그인 폼 초기화
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                    // 활성 세션 목록 새로고침 (모달이 열려있다면)
                    if (document.getElementById('activeSessionsModal').classList.contains('show')) {
                        refreshActiveSessions();
                    }
                } else {
                    alert(result.message || '모든 세션 정리에 실패했습니다.');
                }
            } catch (error) {
                console.error('모든 세션 정리 오류:', error);
                alert('모든 세션 정리에 실패했습니다.');
            }
        }
    </script>
</body>
</html>
